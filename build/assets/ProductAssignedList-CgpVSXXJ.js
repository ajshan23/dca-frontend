import{r as i,J as U,T as _,j as t}from"./index-xBb4Cu5p.js";import{A as K}from"./AdaptableCard-C8NAqNcm.js";import"./Views--okuRfCK.js";import{S as k}from"./index-CCxRe_lL.js";import"./chart.config-TIV3arlo.js";import"./index-DUchRYx7.js";import{B as o}from"./Button-DpFfS7qi.js";import{t as E,N as R,D as O}from"./Upload-Br0nJyki.js";import{D as W}from"./DataTable-DPSpAcGJ.js";import{I as X}from"./hoist-non-react-statics.cjs-D9D9Op99.js";import"./SvgIcon-Bg4gHeyf.js";import{y as Y,J as Z,C as L,D as ee,v as te}from"./index-CeosE6Mu.js";import{u as ne}from"./useQuery-C5ra9VKq.js";import{u as v}from"./useMutation-BmpT8JAn.js";import{d as se}from"./debounce-BpHb7X8g.js";import{h as ae,r as ie,n as oe,b as re}from"./ProductService-CjGHow6K.js";import"./Alert-eifFNp7B.js";import"./Card-DUFOzyf7.js";import"./index-B9jXH76y.js";import"./index-DPKcPQiU.js";import"./index-LBerdN8z.js";import"./ScrollBar--d9coRPU.js";import{b as le}from"./index-Dlp3GeUY.js";import"./index-Chjiymov.js";import"./toString-CfufOl4R.js";import"./CloseButton-B3Yr_F5T.js";import"./cloneDeep-DJN0yfLA.js";import"./useThemeClass-CVZ0ENSo.js";import"./_getPrototype-RCTy2yb6.js";const ce=()=>{var S,D,I;const P=i.useRef(null),f=U(),j=_(),[y,Q]=i.useState(""),[c,x]=i.useState({page:1,limit:10}),[p,F]=i.useState(!1),[s,u]=i.useState({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"}),[r,d]=i.useState({open:!1,assignment:null}),[g,T]=i.useState(null);i.useEffect(()=>{const e=localStorage.getItem("user");if(e)try{T(JSON.parse(e))}catch(n){console.error("Error parsing user data:",n)}},[]);const{data:l,isLoading:q,error:b,refetch:G}=ne({queryKey:["active-assignments",c,y,p],queryFn:()=>re({page:c.page,limit:c.limit,search:y,overdue:p})}),N=v({mutationFn:e=>ae(e.assignmentId,{condition:e.condition,notes:e.notes,inventoryStatus:e.inventoryStatus}),onSuccess:()=>{m("Product returned successfully","success"),j.invalidateQueries(["active-assignments"]),h()},onError:e=>{var n,a;m(((a=(n=e.response)==null?void 0:n.data)==null?void 0:a.message)||"Failed to return product","danger")}}),C=v({mutationFn:ie,onSuccess:()=>{m("Assignment deleted successfully","success"),j.invalidateQueries(["active-assignments"]),d({open:!1,assignment:null})},onError:e=>{var n,a;m(((a=(n=e.response)==null?void 0:n.data)==null?void 0:a.message)||"Failed to delete assignment","danger")}}),{mutate:A,isPending:w}=v({mutationFn:async e=>{var a;const n=await oe(e);if(!((a=n.data)!=null&&a.qrCode))throw new Error("Invalid QR code data received from server");return{qrCode:n.data.qrCode,assignmentInfo:n.data.assignmentInfo}},onSuccess:e=>{V(e.qrCode,e.assignmentInfo)},onError:e=>{E.push(t.jsx(R,{title:"Error",type:"danger",children:e.message||"Failed to generate assignment QR code"}))}}),m=(e,n)=>{E.push(t.jsx(R,{title:n==="success"?"Success":"Error",type:n,children:e}))},M=i.useMemo(()=>se(e=>{Q(e),x(n=>({...n,page:1}))},500),[]),h=()=>{u({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"})},$=e=>{u({...s,open:!0,assignment:{id:e.id,productName:e.product.name,inventoryInfo:e.inventory.serialNumber||`Item #${e.inventory.id}`}})},B=e=>{d({open:!0,assignment:{id:e.id,productName:e.product.name,employeeName:e.employee.name}})},z=async()=>{var e;(e=r.assignment)!=null&&e.id&&await C.mutateAsync(r.assignment.id)},H=async()=>{var e;if(!((e=s.assignment)!=null&&e.id)){m("No valid assignment selected","danger");return}await N.mutateAsync({assignmentId:s.assignment.id,condition:s.condition,inventoryStatus:s.inventoryStatus,notes:`Returned in ${s.condition.toLowerCase()} condition. Inventory status: ${s.inventoryStatus.toLowerCase()}`})},V=(e,n)=>{const a=window.open("","_blank","width=600,height=700");a&&(a.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Assignment QR Code - ${n.productName}</title>
            <style>
              body { 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              }
              .qr-container {
                margin: 20px auto;
                width: 300px;
                height: 300px;
              }
              .assignment-info {
                margin-bottom: 20px;
                text-align: left;
              }
              .info-row {
                margin-bottom: 8px;
              }
              img { width: 100%; height: auto; }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <img src="${e}" alt="Assignment QR Code" />
            </div>
         
          </body>
        </html>
      `),a.document.close())},J=i.useMemo(()=>[{header:"Product",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold block",children:e.row.original.product.name}),t.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.product.model})]})},{header:"Inventory Item",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"block",children:e.row.original.inventory.serialNumber||`Item #${e.row.original.inventory.id}`}),t.jsx("div",{className:"text-xs text-gray-700 mt-1",children:e.row.original.inventory.condition})]})},{header:"Category",cell:e=>e.row.original.product.category.name},{header:"Branch",cell:e=>e.row.original.product.branch.name},{header:"Assigned To",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"block",children:e.row.original.employee.name}),t.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.employee.empId})]})},{header:"Assigned On",cell:e=>new Date(e.row.original.assignedAt).toLocaleDateString()},{header:"Actions",id:"action",cell:e=>{const n=e.row.original;return t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(o,{size:"xs",icon:t.jsx(Y,{}),onClick:()=>f(`/assignments/${n.id}`),title:"View Product"}),t.jsx(o,{size:"xs",variant:"twoTone",icon:t.jsx(Z,{}),onClick:()=>A(n.id),loading:w,title:"Generate QR Code"}),t.jsx(o,{size:"xs",variant:"solid",icon:t.jsx(le,{}),onClick:()=>$(n),children:"Return"}),(g==null?void 0:g.role)==="super_admin"&&t.jsx(o,{size:"xs",variant:"solid",color:"red",icon:t.jsx(L,{}),onClick:()=>B(n),title:"Delete Assignment"})]})}}],[f,A,w,g]);return b?t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsxs("span",{className:"text-red-500",children:["Error: ",b.message]})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[t.jsxs("div",{className:"flex gap-4 flex-1",children:[t.jsx(X,{placeholder:"Search assignments...",onChange:e=>M(e.target.value),className:"max-w-md"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",id:"overdue-filter",checked:p,onChange:e=>F(e.target.checked),className:"rounded"}),t.jsx("label",{htmlFor:"overdue-filter",className:"text-sm",children:"Show overdue only"})]})]}),t.jsx(o,{icon:t.jsx(ee,{}),onClick:()=>G(),children:"Refresh"})]}),t.jsx(W,{ref:P,columns:J,data:((S=l==null?void 0:l.data)==null?void 0:S.data)||[],loading:q,pagingData:{total:((I=(D=l==null?void 0:l.data)==null?void 0:D.pagination)==null?void 0:I.total)||0,pageIndex:c.page,pageSize:c.limit},onPaginationChange:e=>x(n=>({...n,page:e})),onSelectChange:e=>x({page:1,limit:e})}),t.jsxs(O,{isOpen:s.open,onClose:h,onRequestClose:h,width:500,children:[t.jsx("h4",{className:"mb-4",children:"Return Product"}),s.assignment&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),t.jsx("p",{className:"font-semibold",children:s.assignment.productName})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Item"}),t.jsx("p",{className:"text-gray-600",children:s.assignment.inventoryInfo})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Return Condition"}),t.jsx(k,{value:{value:s.condition,label:s.condition.charAt(0).toUpperCase()+s.condition.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:e=>u({...s,condition:e.value})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Status After Return"}),t.jsx(k,{value:{value:s.inventoryStatus,label:s.inventoryStatus.charAt(0).toUpperCase()+s.inventoryStatus.slice(1).toLowerCase()},options:[{value:"AVAILABLE",label:"Available"},{value:"MAINTENANCE",label:"Needs Maintenance"},{value:"DAMAGED",label:"Damaged"}],onChange:e=>u({...s,inventoryStatus:e.value})}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Choose the status for the inventory item after return"})]}),t.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[t.jsx(o,{variant:"plain",onClick:h,children:"Cancel"}),t.jsx(o,{variant:"solid",onClick:H,loading:N.isLoading,icon:t.jsx(te,{}),children:"Confirm Return"})]})]})]}),t.jsxs(O,{isOpen:r.open,onClose:()=>d({open:!1,assignment:null}),onRequestClose:()=>d({open:!1,assignment:null}),width:400,children:[t.jsx("h4",{className:"mb-4",children:"Delete Assignment"}),r.assignment&&t.jsxs("div",{className:"space-y-4",children:[t.jsx("p",{className:"text-gray-600",children:"Are you sure you want to delete this assignment?"}),t.jsxs("div",{className:"bg-red-50 p-3 rounded-md",children:[t.jsx("p",{className:"font-semibold text-red-700",children:r.assignment.productName}),t.jsxs("p",{className:"text-red-600 text-sm",children:["Assigned to: ",r.assignment.employeeName]})]}),t.jsx("p",{className:"text-sm text-gray-500",children:"This action will return the inventory item to available stock and cannot be undone."}),t.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[t.jsx(o,{variant:"plain",onClick:()=>d({open:!1,assignment:null}),children:"Cancel"}),t.jsx(o,{variant:"solid",color:"red",onClick:z,loading:C.isLoading,icon:t.jsx(L,{}),children:"Delete Assignment"})]})]})]})]})},Ge=()=>t.jsxs(K,{className:"h-full",bodyClass:"h-full",children:[t.jsx("div",{className:"lg:flex items-center justify-between mb-4",children:t.jsx("h3",{className:"mb-4 lg:mb-0",children:"Product Assignments"})}),t.jsx(ce,{})]});export{Ge as default};
