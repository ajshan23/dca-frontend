import{r as l,J as ne,T as Ce,j as e}from"./index-muC5t9Ff.js";import{A as Ae}from"./AdaptableCard-Dyp-uRwZ.js";import"./Views-C3GxPXgN.js";import{S as N}from"./index-icLoo5qJ.js";import"./chart.config-p-sgkeRp.js";import"./index-yo59Bp53.js";import{B as n}from"./Button-Cq4alaT0.js";import{D as L,a as we,t as o,N as r}from"./Upload-vjAJbhnt.js";import{D as Oe}from"./DataTable-FA7rzLtO.js";import{I as C}from"./hoist-non-react-statics.cjs-DKZ9AQfH.js";import"./SvgIcon-Rif3hBwp.js";import{v as Pe,w as Ie,z as Ee,A as Fe,B as De,u as Le,y as Re}from"./index-D96OsuYe.js";import{u as Te}from"./useThemeClass-DyFeISBg.js";import{u as le}from"./useQuery-BBkjt_nW.js";import{u as R}from"./useMutation-al4z5gF0.js";import{d as qe}from"./debounce-B-RLd5L-.js";import{d as ze,e as Me,f as Be,g as Ge,h as Qe}from"./ProductService-Cs7r9EgM.js";import{a as $e}from"./EmployeeService.ts-DmR1Erip.js";import"./Alert-Db7iKZF3.js";import"./Card-D-zSwa-m.js";import"./index-CUvccuOF.js";import"./Drawer-ncXPq6qF.js";import"./index-CI1EklAn.js";import"./index-CzJbgWfX.js";import"./ScrollBar-D0b1sb-w.js";import{B as He}from"./index-BdNrlirX.js";import"./index-Chjiymov.js";import"./toString-uiPiEOqw.js";import"./proxy-CgEaBNsd.js";import"./CloseButton-B0qHPwpH.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-DMo6pgiu.js";const Ke=()=>{var Z,ee,se,te,ae;const A=l.useRef(null),w=ne(),O=Ce(),{textTheme:ie}=Te(),[T,oe]=l.useState(""),[u,P]=l.useState({page:1,limit:10}),[x,re]=l.useState(""),[ce,q]=l.useState(!1),[de,me]=l.useState(!1),[ue,z]=l.useState(!1),[i,b]=l.useState(null),[c,xe]=l.useState(null),[d,M]=l.useState(null),[j,B]=l.useState(null),[G,Q]=l.useState(""),[h,$]=l.useState("GOOD"),[I,E]=l.useState([]),[p,H]=l.useState(null),[g,K]=l.useState(1),[v,F]=l.useState([""]),{data:m,isLoading:he,error:_,refetch:pe}=le({queryKey:["products",u,T,x],queryFn:()=>Qe({page:u.page,limit:u.limit,search:T,stockStatus:x||void 0})}),{data:f}=le({queryKey:["employees-for-assignment"],queryFn:()=>$e({page:1,limit:100})}),U=R({mutationFn:Me,onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product assigned successfully"})),O.invalidateQueries(["products"]),y()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),W=R({mutationFn:s=>Ge(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product returned successfully"})),O.invalidateQueries(["products"]),S()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),J=R({mutationFn:s=>Be(s.productId,s.stockData),onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),O.invalidateQueries(["products"]),k()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),ge=l.useMemo(()=>qe(s=>{oe(s),P(t=>({...t,page:1}))},500),[]),y=()=>{b(null),M(null),H(null),B(null),Q(""),E([]),q(!1)},S=()=>{xe(null),$("GOOD"),me(!1)},k=()=>{b(null),K(1),F([""]),z(!1)},ve=async s=>{var t;b({id:s.id,name:s.name});try{const a=await ze(s.id);E(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),E([])}q(!0)},be=s=>{b({id:s.id,name:s.name}),z(!0)},je=async()=>{!i||!d||await U.mutateAsync({productId:i.id,employeeId:d,inventoryId:p||void 0,expectedReturnAt:j==null?void 0:j.toISOString(),notes:G,autoSelect:!p})},fe=async()=>{if(!(c!=null&&c.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await W.mutateAsync({assignmentId:c.id,condition:h,notes:`Returned in ${h.toLowerCase()} condition`})},ye=async()=>{if(!i)return;const s={quantity:g,serialNumbers:v.filter(t=>t.trim()),reason:"Stock replenishment"};await J.mutateAsync({productId:i.id,stockData:s})},V=l.useMemo(()=>{var s,t;return((t=(s=f==null?void 0:f.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId})`})))||[]},[f]),X=l.useMemo(()=>I.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[I]),Y=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],Se=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx("div",{className:"text-red-600 bg-red-50 px-2 py-1 rounded text-sm",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs("div",{className:"text-yellow-600 bg-yellow-50 px-2 py-1 rounded text-sm",children:["Low Stock (",a,")"]});default:return e.jsxs("div",{className:"text-green-600 bg-green-50 px-2 py-1 rounded text-sm",children:["Available (",a,")"]})}},ke=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[Se(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx("div",{className:s.row.original.complianceStatus?"text-green-600 bg-green-50 px-2 py-1 rounded text-sm":"text-red-600 bg-red-50 px-2 py-1 rounded text-sm",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-2",children:[e.jsx(n,{size:"xs",icon:e.jsx(Pe,{}),onClick:()=>w(`/products/view/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Ie,{}),onClick:()=>w(`/products/edit/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Ee,{}),onClick:()=>be(t),variant:"twoTone",children:"Stock"}),a?e.jsx(n,{size:"xs",icon:e.jsx(Fe,{}),onClick:()=>ve(t),variant:"solid",children:"Assign"}):e.jsx(n,{size:"xs",disabled:!0,variant:"plain",children:"No Stock"})]})}}],[w,ie]);return _?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",_.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(C,{placeholder:"Search products...",onChange:s=>ge(s.target.value),className:"max-w-md"}),e.jsx(N,{placeholder:"Filter by stock",options:Y,value:x?{value:x,label:(Z=Y.find(s=>s.value===x))==null?void 0:Z.label}:null,onChange:s=>re((s==null?void 0:s.value)||""),className:"min-w-[200px]",isClearable:!0})]}),e.jsx(n,{icon:e.jsx(De,{}),onClick:()=>pe(),children:"Refresh"})]}),e.jsx(Oe,{ref:A,columns:ke,data:((ee=m==null?void 0:m.data)==null?void 0:ee.data)||[],loading:he,pagingData:{total:((se=m==null?void 0:m.data)==null?void 0:se.total)||0,pageIndex:u.page,pageSize:u.limit},onPaginationChange:s=>P(t=>({...t,page:s})),onSelectChange:s=>P({page:1,limit:s})}),e.jsxs(L,{isOpen:ce,onClose:y,onRequestClose:y,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(N,{placeholder:"Select Employee",options:V,value:d?{value:d,label:(te=V.find(s=>s.value===d))==null?void 0:te.label}:null,onChange:s=>M(s==null?void 0:s.value)})]}),I.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(N,{placeholder:"Auto-select available item",options:X,value:p?{value:p,label:(ae=X.find(s=>s.value===p))==null?void 0:ae.label}:null,onChange:s=>H(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Expected Return Date (Optional)"}),e.jsx(we,{placeholder:"Select date",value:j,onChange:s=>B(s)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(C,{type:"text",value:G,onChange:s=>Q(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:y,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:je,loading:U.isLoading,disabled:!d,children:"Confirm Assignment"})]})]})]}),e.jsx(L,{isOpen:ue,onClose:k,onRequestClose:k,width:500,children:e.jsxs("div",{className:"max-h-[80vh] flex flex-col",children:[e.jsx("h4",{className:"mb-4 flex-shrink-0",children:"Add Stock"}),i&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto pr-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(C,{type:"number",min:"1",max:"100",value:g,onChange:s=>{const t=Number(s.target.value);K(t);const a=Array.from({length:t},(D,Ne)=>v[Ne]||"");F(a)}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Serial Numbers (Optional - ",v.filter(s=>s.trim()).length," of ",g," filled)"]}),g>10&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-2 mb-2",children:e.jsx("p",{className:"text-sm text-yellow-700",children:"Large quantity detected. Consider using batch serial number format or leave empty for auto-generation."})}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded p-3 bg-gray-50",style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsx("div",{className:"space-y-2",children:Array.from({length:g},(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-8 flex-shrink-0",children:["#",t+1]}),e.jsx(C,{type:"text",placeholder:`Serial number ${t+1}`,value:v[t]||"",onChange:a=>{const D=[...v];D[t]=a.target.value,F(D)},className:"flex-1",size:"sm"})]},t))})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Leave empty for non-serialized items. Scroll within the box above for many items."})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t flex-shrink-0",children:[e.jsx(n,{variant:"plain",onClick:k,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:ye,loading:J.isLoading,icon:e.jsx(He,{}),children:"Add Stock"})]})]})]})}),e.jsxs(L,{isOpen:de,onClose:S,onRequestClose:S,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(N,{value:{value:h,label:h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>$(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:S,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:fe,loading:W.isLoading,icon:e.jsx(Le,{}),children:"Confirm Return"})]})]})]})]})},_e=()=>{const A=ne();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(n,{variant:"solid",size:"sm",icon:e.jsx(Re,{}),onClick:()=>A("/products/create"),children:"Add Product"})})},Cs=()=>e.jsxs(Ae,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(_e,{})]}),e.jsx(Ke,{})]});export{Cs as default};
