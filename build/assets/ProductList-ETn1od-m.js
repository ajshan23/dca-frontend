import{r as l,J as ce,T as Pe,j as e}from"./index-BnCfoMHD.js";import{A as Ie}from"./AdaptableCard-DRDRsK4S.js";import"./Views-CznXWnk6.js";import{S as k}from"./index-DhA5XCq6.js";import"./chart.config-9iJEhXYE.js";import"./index-egu2WkrI.js";import{B as n}from"./Button-D0dNB7EA.js";import{D as L,a as Ee,t as o,N as r}from"./Upload-M3k4SvBs.js";import{D as Fe}from"./DataTable-DVOpipVd.js";import{I as C}from"./hoist-non-react-statics.cjs-kw-40s0n.js";import"./SvgIcon-CJp1Ih51.js";import{w as De,x as Le,A as Re,B as Te,C as qe,v as Me,z as ze}from"./index-CYFR1aV4.js";import{u as Be}from"./useThemeClass-BLMMXnwv.js";import{u as oe}from"./useQuery-5MtxfOZF.js";import{u as R}from"./useMutation-BELCJlum.js";import{d as re}from"./debounce-D281xMjJ.js";import{d as $e,e as Ge,f as Qe,g as He,h as Ke}from"./ProductService-BQ89cDEA.js";import{a as _e}from"./EmployeeService.ts-B_8jWz8B.js";import"./Alert-D4E-6k3L.js";import"./Card-BqTJnQ0J.js";import"./index-D-LI7_5Q.js";import"./Drawer-Cq4yK1Bv.js";import"./index-CgT_ZDHR.js";import"./index-pUngdIyx.js";import"./ScrollBar-EjHuuRdS.js";import{B as Ue}from"./index-BGSK8BQs.js";import"./index-Chjiymov.js";import"./toString-BDdrKkq0.js";import"./proxy-Bkf0PZo_.js";import"./CloseButton-BdzNm3ol.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-BbFq-AiP.js";const We=()=>{var te,ae,le,ne,ie;const A=l.useRef(null),O=ce(),w=Pe(),{textTheme:de}=Be(),[T,me]=l.useState(""),[u,P]=l.useState({page:1,limit:10}),[x,ue]=l.useState(""),[q,M]=l.useState(!1),[xe,he]=l.useState(!1),[pe,z]=l.useState(!1),[i,j]=l.useState(null),[c,ge]=l.useState(null),[d,B]=l.useState(null),[f,$]=l.useState(null),[G,Q]=l.useState(""),[h,H]=l.useState("GOOD"),[I,E]=l.useState([]),[p,K]=l.useState(null),[g,_]=l.useState(1),[v,F]=l.useState([""]),[U,W]=l.useState(""),{data:m,isLoading:ve,error:J,refetch:be}=oe({queryKey:["products",u,T,x],queryFn:()=>Ke({page:u.page,limit:u.limit,search:T,stockStatus:x||void 0})}),{data:b,refetch:Ve}=oe({queryKey:["employees-for-assignment",U],queryFn:()=>_e({page:1,limit:100,search:U}),enabled:q}),V=R({mutationFn:Ge,onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product assigned successfully"})),w.invalidateQueries(["products"]),y()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),X=R({mutationFn:s=>He(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product returned successfully"})),w.invalidateQueries(["products"]),S()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),Y=R({mutationFn:s=>Qe(s.productId,s.stockData),onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),w.invalidateQueries(["products"]),N()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),je=l.useMemo(()=>re(s=>{me(s),P(t=>({...t,page:1}))},500),[]),fe=l.useMemo(()=>re(s=>{W(s)},300),[]),y=()=>{j(null),B(null),K(null),$(null),Q(""),E([]),W(""),M(!1)},S=()=>{ge(null),H("GOOD"),he(!1)},N=()=>{j(null),_(1),F([""]),z(!1)},ye=async s=>{var t;j({id:s.id,name:s.name});try{const a=await $e(s.id);E(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),E([])}M(!0)},Se=s=>{j({id:s.id,name:s.name}),z(!0)},Ne=async()=>{!i||!d||await V.mutateAsync({productId:i.id,employeeId:d,inventoryId:p||void 0,expectedReturnAt:f==null?void 0:f.toISOString(),notes:G,autoSelect:!p})},ke=async()=>{if(!(c!=null&&c.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await X.mutateAsync({assignmentId:c.id,condition:h,notes:`Returned in ${h.toLowerCase()} condition`})},Ce=async()=>{if(!i)return;const s={quantity:g,serialNumbers:v.filter(t=>t.trim()),reason:"Stock replenishment"};await Y.mutateAsync({productId:i.id,stockData:s})},Z=l.useMemo(()=>{var s,t;return((t=(s=b==null?void 0:b.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId}) - ${a.department}`,employee:a})))||[]},[b]),ee=l.useMemo(()=>I.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[I]),se=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],Ae=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx("div",{className:"text-red-600 px-2 py-1 rounded text-sm",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs("div",{className:"text-yellow-600  px-2 py-1 rounded text-sm",children:["Low Stock (",a,")"]});default:return e.jsxs("div",{className:"text-green-600  px-2 py-1 rounded text-sm",children:["Available (",a,")"]})}},Oe=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[Ae(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx("div",{className:s.row.original.complianceStatus?"text-green-600 px-2 py-1 rounded text-sm":"text-red-600  px-2 py-1 rounded text-sm",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-2",children:[e.jsx(n,{size:"xs",icon:e.jsx(De,{}),onClick:()=>O(`/products/view/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Le,{}),onClick:()=>O(`/products/edit/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Re,{}),onClick:()=>Se(t),variant:"twoTone",children:"Stock"}),a?e.jsx(n,{size:"xs",icon:e.jsx(Te,{}),onClick:()=>ye(t),variant:"solid",children:"Assign"}):e.jsx(n,{size:"xs",disabled:!0,variant:"plain",children:"No Stock"})]})}}],[O,de]);return J?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",J.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(C,{placeholder:"Search products...",onChange:s=>je(s.target.value),className:"max-w-md"}),e.jsx(k,{placeholder:"Filter by stock",options:se,value:x?{value:x,label:(te=se.find(s=>s.value===x))==null?void 0:te.label}:null,onChange:s=>ue((s==null?void 0:s.value)||""),className:"min-w-[200px]",isClearable:!0})]}),e.jsx(n,{icon:e.jsx(qe,{}),onClick:()=>be(),children:"Refresh"})]}),e.jsx(Fe,{ref:A,columns:Oe,data:((ae=m==null?void 0:m.data)==null?void 0:ae.data)||[],loading:ve,pagingData:{total:((le=m==null?void 0:m.data)==null?void 0:le.total)||0,pageIndex:u.page,pageSize:u.limit},onPaginationChange:s=>P(t=>({...t,page:s})),onSelectChange:s=>P({page:1,limit:s})}),e.jsxs(L,{isOpen:q,onClose:y,onRequestClose:y,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(k,{placeholder:"Search and select employee",options:Z,value:d?{value:d,label:(ne=Z.find(s=>s.value===d))==null?void 0:ne.label}:null,onChange:s=>B(s==null?void 0:s.value),onInputChange:s=>fe(s),isSearchable:!0,isLoading:!b}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Type to search employees by name, ID, or email"})]}),I.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(k,{placeholder:"Auto-select available item",options:ee,value:p?{value:p,label:(ie=ee.find(s=>s.value===p))==null?void 0:ie.label}:null,onChange:s=>K(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Expected Return Date (Optional)"}),e.jsx(Ee,{placeholder:"Select date",value:f,onChange:s=>$(s)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(C,{type:"text",value:G,onChange:s=>Q(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:y,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:Ne,loading:V.isLoading,disabled:!d,children:"Confirm Assignment"})]})]})]}),e.jsx(L,{isOpen:pe,onClose:N,onRequestClose:N,width:500,children:e.jsxs("div",{className:"max-h-[80vh] flex flex-col",children:[e.jsx("h4",{className:"mb-4 flex-shrink-0",children:"Add Stock"}),i&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto pr-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(C,{type:"number",min:"1",max:"100",value:g,onChange:s=>{const t=Number(s.target.value);_(t);const a=Array.from({length:t},(D,we)=>v[we]||"");F(a)}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Serial Numbers (Optional - ",v.filter(s=>s.trim()).length," of ",g," filled)"]}),g>10&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-2 mb-2",children:e.jsx("p",{className:"text-sm text-yellow-700",children:"Large quantity detected. Consider using batch serial number format or leave empty for auto-generation."})}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded p-3 bg-gray-50",style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsx("div",{className:"space-y-2",children:Array.from({length:g},(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-8 flex-shrink-0",children:["#",t+1]}),e.jsx(C,{type:"text",placeholder:`Serial number ${t+1}`,value:v[t]||"",onChange:a=>{const D=[...v];D[t]=a.target.value,F(D)},className:"flex-1",size:"sm"})]},t))})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Leave empty for non-serialized items. Scroll within the box above for many items."})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t flex-shrink-0",children:[e.jsx(n,{variant:"plain",onClick:N,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:Ce,loading:Y.isLoading,icon:e.jsx(Ue,{}),children:"Add Stock"})]})]})]})}),e.jsxs(L,{isOpen:xe,onClose:S,onRequestClose:S,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(k,{value:{value:h,label:h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>H(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:S,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:ke,loading:X.isLoading,icon:e.jsx(Me,{}),children:"Confirm Return"})]})]})]})]})},Je=()=>{const A=ce();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(n,{variant:"solid",size:"sm",icon:e.jsx(ze,{}),onClick:()=>A("/products/create"),children:"Add Product"})})},Ps=()=>e.jsxs(Ie,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(Je,{})]}),e.jsx(We,{})]});export{Ps as default};
