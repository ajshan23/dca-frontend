import{r as l,J as fe,T as _e,U as Ke,V as Ue,j as e}from"./index-TEH5dBCx.js";import{A as Ve}from"./AdaptableCard-gXf7GmI6.js";import"./Views-DMwcHtdt.js";import{S as E}from"./index-McEAQz1s.js";import"./chart.config-wVxolKoX.js";import"./index-OS1leKni.js";import{B as i}from"./Button-BUzKSCMu.js";import{D as I,t as o,N as r}from"./Upload-e7Mj5fP7.js";import{D as We}from"./DataTable-BCgO2BLt.js";import{I as y}from"./hoist-non-react-statics.cjs-DWnuqmCi.js";import"./SvgIcon-nhUS7VPd.js";import{y as Je,w as Xe,A as Ye,B as Ze,C as es,D as ss,E as H,v as ve,z as ts}from"./index-DexGGemz.js";import{u as as}from"./useThemeClass-CSXPPH7w.js";import{u as je}from"./useQuery-B_1zV9qe.js";import{u as D}from"./useMutation-DS0QITqb.js";import{d as be}from"./debounce-rBX5poEG.js";import{d as ls,e as ns,f as is,g as os,h as rs,i as cs}from"./ProductService-b_0bMy20.js";import{a as ds}from"./EmployeeService.ts-C3LAhIAx.js";import"./Alert-p0GbirZ_.js";import"./Card-Dhe7HhRs.js";import"./index-suFKXivx.js";import"./index-DeR0D_24.js";import"./index-CO7yGqxa.js";import"./ScrollBar-D_OdJclh.js";import{B as ms}from"./index-DthDNFYw.js";import"./index-Chjiymov.js";import"./toString-UKiOXWKD.js";import"./CloseButton-DFP83YRg.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-oH1nSSDt.js";const us=()=>{var me,ue,xe,he,pe,ge;const F=l.useRef(null),R=fe(),S=_e(),{textTheme:ye}=as(),[h,Se]=l.useState(null),[B,Ne]=l.useState(""),[p,N]=l.useState({page:1,limit:10}),[g,ke]=l.useState(""),[Q,$]=l.useState(!1),[Ce,Ae]=l.useState(!1),[we,G]=l.useState(!1),[Pe,_]=l.useState(!1),[d,k]=l.useState(null),[n,K]=l.useState(null),[m,Oe]=l.useState(null),[u,U]=l.useState(null),[T,Ee]=l.useState(null),[V,W]=l.useState(""),[J,X]=l.useState(""),[v,Y]=l.useState("GOOD"),[L,M]=l.useState([]),[j,Z]=l.useState(null),[C,ee]=l.useState(1),[b,q]=l.useState([""]),[se,te]=l.useState("");l.useEffect(()=>{var c;const s=localStorage.getItem(Ke),t=Ue(s);console.log("Raw persist data:",s),console.log("Parsed persist data:",t);let a=(c=t==null?void 0:t.auth)==null?void 0:c.session;console.log("Session from persist data:",a),a?(Se(a),console.log("Current user set:",a)):console.warn("No session found in persist data")},[]);const{data:x,isLoading:Ie,error:ae,refetch:De}=je({queryKey:["products",p,B,g],queryFn:()=>cs({page:p.page,limit:p.limit,search:B,stockStatus:g||void 0}),keepPreviousData:!0}),{data:f,refetch:hs}=je({queryKey:["employees-for-assignment",se],queryFn:()=>ds({page:1,limit:100,search:se}),enabled:Q}),le=D({mutationFn:is,onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product assigned successfully"})),S.invalidateQueries(["products"]),A()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),ne=D({mutationFn:s=>rs(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product returned successfully"})),S.invalidateQueries(["products"]),w()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),ie=D({mutationFn:s=>os(s.productId,s.stockData),onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),S.invalidateQueries(["products"]),P()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),oe=D({mutationFn:ns,onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Product deleted successfully"})),S.invalidateQueries(["products"]),O()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to delete product"}))}}),Fe=l.useMemo(()=>be(s=>{Ne(s),N(t=>({...t,page:1}))},500),[]),Re=l.useMemo(()=>be(s=>{te(s)},300),[]),A=()=>{k(null),U(null),Z(null),Ee(null),W(""),X(""),M([]),te(""),$(!1)},w=()=>{Oe(null),Y("GOOD"),Ae(!1)},P=()=>{k(null),ee(1),q([""]),G(!1)},O=()=>{K(null),_(!1)},Te=async s=>{var t;k({id:s.id,name:s.name});try{const a=await ls(s.id);M(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),M([])}$(!0)},Le=s=>{k({id:s.id,name:s.name}),G(!0)},Me=s=>{const t=s.stockInfo.totalStock>0,a=s.stockInfo.assignedStock>0;K({id:s.id,name:s.name,model:s.model,hasStock:t,hasActiveAssignments:a}),_(!0)},qe=async()=>{!d||!u||await le.mutateAsync({productId:d.id,employeeId:u,inventoryId:j||void 0,expectedReturnAt:T==null?void 0:T.toISOString(),notes:V,pcName:J.trim()||void 0,autoSelect:!j})},ze=async()=>{if(!(m!=null&&m.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await ne.mutateAsync({assignmentId:m.id,condition:v,notes:`Returned in ${v.toLowerCase()} condition`})},He=async()=>{if(!d)return;const s={quantity:C,serialNumbers:b.filter(t=>t.trim()),reason:"Stock replenishment"};await ie.mutateAsync({productId:d.id,stockData:s})},Be=async()=>{if(!(n!=null&&n.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No product selected for deletion"}));return}await oe.mutateAsync(n.id)},re=l.useMemo(()=>{var s,t;return((t=(s=f==null?void 0:f.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId}) - ${a.department}`,employee:a})))||[]},[f]),ce=l.useMemo(()=>L.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[L]),de=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],Qe=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx("div",{className:"text-red-600 px-2 py-1 rounded text-sm",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs("div",{className:"text-yellow-600  px-2 py-1 rounded text-sm",children:["Low Stock (",a,")"]});default:return e.jsxs("div",{className:"text-green-600  px-2 py-1 rounded text-sm",children:["Available (",a,")"]})}},z=(h==null?void 0:h.role)==="super_admin";console.log("Current user in render:",h),console.log("Is super admin:",z);const $e=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[Qe(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx("div",{className:s.row.original.complianceStatus?"text-green-600 px-2 py-1 rounded text-sm":"text-red-600  px-2 py-1 rounded text-sm",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0,c=t.stockInfo.assignedStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-1",children:[e.jsx(i,{size:"xs",icon:e.jsx(Je,{}),onClick:()=>R(`/products/view/${t.id}`),title:"View Product"}),e.jsx(i,{size:"xs",icon:e.jsx(Xe,{}),onClick:()=>R(`/products/edit/${t.id}`),title:"Edit Product"}),e.jsx(i,{size:"xs",icon:e.jsx(Ye,{}),onClick:()=>Le(t),variant:"twoTone",title:"Add Stock",children:"Stock"}),a?e.jsx(i,{size:"xs",icon:e.jsx(Ze,{}),onClick:()=>Te(t),variant:"solid",title:"Assign Product",children:"Assign"}):e.jsx(i,{size:"xs",disabled:!0,variant:"plain",title:"No stock available",children:"No Stock"}),z&&e.jsx(i,{size:"xs",icon:e.jsx(es,{}),onClick:()=>Me(t),variant:"plain",className:"text-red-600 hover:text-red-800 hover:bg-red-50",title:c?"Cannot delete - has active assignments":"Delete Product",disabled:c,children:"Delete"})]})}}],[R,ye,h,z]);return ae?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",ae.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(y,{placeholder:"Search products...",onChange:s=>Fe(s.target.value),className:"max-w-md"}),e.jsx(E,{placeholder:"Filter by stock",options:de,value:g?{value:g,label:(me=de.find(s=>s.value===g))==null?void 0:me.label}:null,onChange:s=>{ke((s==null?void 0:s.value)||""),N(t=>({...t,page:1}))},className:"min-w-[200px]",isClearable:!0})]}),e.jsx(i,{icon:e.jsx(ss,{}),onClick:()=>De(),children:"Refresh"})]}),e.jsx(We,{ref:F,columns:$e,data:((ue=x==null?void 0:x.data)==null?void 0:ue.data)||[],loading:Ie,pagingData:{total:((he=(xe=x==null?void 0:x.data)==null?void 0:xe.pagination)==null?void 0:he.total)||0,pageIndex:p.page,pageSize:p.limit},onPaginationChange:s=>N(t=>({...t,page:s})),onSelectChange:s=>N({page:1,limit:s})}),e.jsx(I,{isOpen:Pe,onClose:O,onRequestClose:O,width:500,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4",children:e.jsx(H,{className:"h-6 w-6 text-red-600"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Delete Product"}),n&&e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Are you sure you want to delete this product? This action cannot be undone."}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"text-left space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Product:"}),e.jsx("span",{className:"ml-2",children:n.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Model:"}),e.jsx("span",{className:"ml-2",children:n.model})]})]})}),n.hasActiveAssignments&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{className:"h-5 w-5 text-red-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Cannot Delete Product"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:"This product has active assignments and cannot be deleted. Please return all assigned items before deletion."})})]})]})}),n.hasStock&&!n.hasActiveAssignments&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{className:"h-5 w-5 text-yellow-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Warning: Product Has Inventory"}),e.jsx("div",{className:"mt-2 text-sm text-yellow-700",children:e.jsx("p",{children:"This product has inventory items. Deleting will also remove all associated inventory records."})})]})]})}),!n.hasStock&&!n.hasActiveAssignments&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(ve,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-green-800",children:"Safe to Delete"}),e.jsx("div",{className:"mt-2 text-sm text-green-700",children:e.jsx("p",{children:"This product has no inventory or active assignments."})})]})]})})]}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(i,{variant:"plain",onClick:O,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:Be,loading:oe.isLoading,disabled:n==null?void 0:n.hasActiveAssignments,className:"bg-red-600 hover:bg-red-700 text-white",children:n!=null&&n.hasActiveAssignments?"Cannot Delete":"Delete Product"})]})]})}),e.jsxs(I,{isOpen:Q,onClose:A,onRequestClose:A,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:d.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(E,{placeholder:"Search and select employee",options:re,value:u?{value:u,label:(pe=re.find(s=>s.value===u))==null?void 0:pe.label}:null,onChange:s=>U(s==null?void 0:s.value),onInputChange:s=>Re(s),isSearchable:!0,isLoading:!f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Type to search employees by name, ID, or email"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"PC Name (Optional)"}),e.jsx(y,{type:"text",value:J,onChange:s=>X(s.target.value),placeholder:"Enter pc name",maxLength:50}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Enter the PC identifier for tracking purposes"})]}),L.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(E,{placeholder:"Auto-select available item",options:ce,value:j?{value:j,label:(ge=ce.find(s=>s.value===j))==null?void 0:ge.label}:null,onChange:s=>Z(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(y,{type:"text",value:V,onChange:s=>W(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:A,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:qe,loading:le.isLoading,disabled:!u,children:"Confirm Assignment"})]})]})]}),e.jsx(I,{isOpen:we,onClose:P,onRequestClose:P,width:500,children:e.jsxs("div",{className:"max-h-[80vh] flex flex-col",children:[e.jsx("h4",{className:"mb-4 flex-shrink-0",children:"Add Stock"}),d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto pr-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Product: ",e.jsx("span",{className:"font-semibold",children:d.name})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(y,{type:"number",min:"1",max:"100",value:C,onChange:s=>{const t=Number(s.target.value);ee(t);const a=Array.from({length:t},(c,Ge)=>b[Ge]||"");q(a)}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Serial Numbers (Optional - ",b.filter(s=>s.trim()).length," of ",C," filled)"]}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded p-3 bg-gray-50",style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsx("div",{className:"space-y-2",children:Array.from({length:C},(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-8 flex-shrink-0",children:["#",t+1]}),e.jsx(y,{type:"text",placeholder:`Serial number ${t+1}`,value:b[t]||"",onChange:a=>{const c=[...b];c[t]=a.target.value,q(c)},className:"flex-1",size:"sm"})]},t))})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Leave empty for non-serialized items. Scroll within the box above for many items."})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t flex-shrink-0",children:[e.jsx(i,{variant:"plain",onClick:P,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:He,loading:ie.isLoading,icon:e.jsx(ms,{}),children:"Add Stock"})]})]})]})}),e.jsxs(I,{isOpen:Ce,onClose:w,onRequestClose:w,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:m.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(E,{value:{value:v,label:v.charAt(0).toUpperCase()+v.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>Y(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:w,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:ze,loading:ne.isLoading,icon:e.jsx(ve,{}),children:"Confirm Return"})]})]})]})]})},xs=()=>{const F=fe();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(i,{variant:"solid",size:"sm",icon:e.jsx(ts,{}),onClick:()=>F("/products/create"),children:"Add Product"})})},_s=()=>e.jsxs(Ve,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(xs,{})]}),e.jsx(us,{})]});export{_s as default};
