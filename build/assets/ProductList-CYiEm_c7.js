import{r as l,J as re,T as Ie,j as e}from"./index-CqLxfmTZ.js";import{A as Pe}from"./AdaptableCard-D67tKEjo.js";import"./Views-Blffrvmg.js";import{S as N}from"./index-C56ociV3.js";import"./chart.config-dzWEMOsD.js";import"./index-B44et8BF.js";import{B as n}from"./Button-D8F_il60.js";import{D as L,t as o,N as r}from"./Upload-DEV7FleW.js";import{D as Ee}from"./DataTable-rtRBxPXL.js";import{I as k}from"./hoist-non-react-statics.cjs-CDAZM20A.js";import"./SvgIcon-CaN89z7E.js";import{w as Fe,x as De,A as Le,B as Te,C as Re,v as qe,z as Me}from"./index-BI3QDeQ3.js";import{u as ze}from"./useThemeClass-D8C1-D8_.js";import{u as ie}from"./useQuery-AX6UCaHi.js";import{u as T}from"./useMutation-Df37XhDC.js";import{d as oe}from"./debounce-CtPvqRip.js";import{d as Be,e as $e,f as Ge,g as Qe,h as He}from"./ProductService-AQ8yW2uu.js";import{a as Ke}from"./EmployeeService.ts-CmAH9q4Y.js";import"./Alert-_C90Y5Ul.js";import"./Card-DIICHYCU.js";import"./index-CeN3_HJq.js";import"./Drawer-COwaiExO.js";import"./index-BAKhMj1q.js";import"./index-Dt48PFFc.js";import"./ScrollBar-B1-RASww.js";import{B as _e}from"./index-epbKU-ZG.js";import"./index-Chjiymov.js";import"./toString-CgDOi4YX.js";import"./proxy-Cf-BNeT4.js";import"./CloseButton-BxpPNwyp.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-D721kz6E.js";const Ue=()=>{var se,te,ae,le,ne;const C=l.useRef(null),A=re(),w=Ie(),{textTheme:ce}=ze(),[R,de]=l.useState(""),[u,O]=l.useState({page:1,limit:10}),[x,me]=l.useState(""),[q,M]=l.useState(!1),[ue,xe]=l.useState(!1),[he,z]=l.useState(!1),[i,j]=l.useState(null),[c,pe]=l.useState(null),[d,B]=l.useState(null),[I,ge]=l.useState(null),[$,G]=l.useState(""),[h,Q]=l.useState("GOOD"),[P,E]=l.useState([]),[p,H]=l.useState(null),[g,K]=l.useState(1),[v,F]=l.useState([""]),[_,U]=l.useState(""),{data:m,isLoading:ve,error:W,refetch:be}=ie({queryKey:["products",u,R,x],queryFn:()=>He({page:u.page,limit:u.limit,search:R,stockStatus:x||void 0})}),{data:b,refetch:Je}=ie({queryKey:["employees-for-assignment",_],queryFn:()=>Ke({page:1,limit:100,search:_}),enabled:q}),J=T({mutationFn:$e,onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product assigned successfully"})),w.invalidateQueries(["products"]),f()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),V=T({mutationFn:s=>Qe(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product returned successfully"})),w.invalidateQueries(["products"]),y()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),X=T({mutationFn:s=>Ge(s.productId,s.stockData),onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),w.invalidateQueries(["products"]),S()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),je=l.useMemo(()=>oe(s=>{de(s),O(t=>({...t,page:1}))},500),[]),fe=l.useMemo(()=>oe(s=>{U(s)},300),[]),f=()=>{j(null),B(null),H(null),ge(null),G(""),E([]),U(""),M(!1)},y=()=>{pe(null),Q("GOOD"),xe(!1)},S=()=>{j(null),K(1),F([""]),z(!1)},ye=async s=>{var t;j({id:s.id,name:s.name});try{const a=await Be(s.id);E(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),E([])}M(!0)},Se=s=>{j({id:s.id,name:s.name}),z(!0)},Ne=async()=>{!i||!d||await J.mutateAsync({productId:i.id,employeeId:d,inventoryId:p||void 0,expectedReturnAt:I==null?void 0:I.toISOString(),notes:$,autoSelect:!p})},ke=async()=>{if(!(c!=null&&c.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await V.mutateAsync({assignmentId:c.id,condition:h,notes:`Returned in ${h.toLowerCase()} condition`})},Ce=async()=>{if(!i)return;const s={quantity:g,serialNumbers:v.filter(t=>t.trim()),reason:"Stock replenishment"};await X.mutateAsync({productId:i.id,stockData:s})},Y=l.useMemo(()=>{var s,t;return((t=(s=b==null?void 0:b.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId}) - ${a.department}`,employee:a})))||[]},[b]),Z=l.useMemo(()=>P.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[P]),ee=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],Ae=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx("div",{className:"text-red-600 px-2 py-1 rounded text-sm",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs("div",{className:"text-yellow-600  px-2 py-1 rounded text-sm",children:["Low Stock (",a,")"]});default:return e.jsxs("div",{className:"text-green-600  px-2 py-1 rounded text-sm",children:["Available (",a,")"]})}},we=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[Ae(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx("div",{className:s.row.original.complianceStatus?"text-green-600 px-2 py-1 rounded text-sm":"text-red-600  px-2 py-1 rounded text-sm",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-2",children:[e.jsx(n,{size:"xs",icon:e.jsx(Fe,{}),onClick:()=>A(`/products/view/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(De,{}),onClick:()=>A(`/products/edit/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Le,{}),onClick:()=>Se(t),variant:"twoTone",children:"Stock"}),a?e.jsx(n,{size:"xs",icon:e.jsx(Te,{}),onClick:()=>ye(t),variant:"solid",children:"Assign"}):e.jsx(n,{size:"xs",disabled:!0,variant:"plain",children:"No Stock"})]})}}],[A,ce]);return W?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",W.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(k,{placeholder:"Search products...",onChange:s=>je(s.target.value),className:"max-w-md"}),e.jsx(N,{placeholder:"Filter by stock",options:ee,value:x?{value:x,label:(se=ee.find(s=>s.value===x))==null?void 0:se.label}:null,onChange:s=>me((s==null?void 0:s.value)||""),className:"min-w-[200px]",isClearable:!0})]}),e.jsx(n,{icon:e.jsx(Re,{}),onClick:()=>be(),children:"Refresh"})]}),e.jsx(Ee,{ref:C,columns:we,data:((te=m==null?void 0:m.data)==null?void 0:te.data)||[],loading:ve,pagingData:{total:((ae=m==null?void 0:m.data)==null?void 0:ae.total)||0,pageIndex:u.page,pageSize:u.limit},onPaginationChange:s=>O(t=>({...t,page:s})),onSelectChange:s=>O({page:1,limit:s})}),e.jsxs(L,{isOpen:q,onClose:f,onRequestClose:f,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(N,{placeholder:"Search and select employee",options:Y,value:d?{value:d,label:(le=Y.find(s=>s.value===d))==null?void 0:le.label}:null,onChange:s=>B(s==null?void 0:s.value),onInputChange:s=>fe(s),isSearchable:!0,isLoading:!b}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Type to search employees by name, ID, or email"})]}),P.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(N,{placeholder:"Auto-select available item",options:Z,value:p?{value:p,label:(ne=Z.find(s=>s.value===p))==null?void 0:ne.label}:null,onChange:s=>H(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(k,{type:"text",value:$,onChange:s=>G(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:f,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:Ne,loading:J.isLoading,disabled:!d,children:"Confirm Assignment"})]})]})]}),e.jsx(L,{isOpen:he,onClose:S,onRequestClose:S,width:500,children:e.jsxs("div",{className:"max-h-[80vh] flex flex-col",children:[e.jsx("h4",{className:"mb-4 flex-shrink-0",children:"Add Stock"}),i&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto pr-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(k,{type:"number",min:"1",max:"100",value:g,onChange:s=>{const t=Number(s.target.value);K(t);const a=Array.from({length:t},(D,Oe)=>v[Oe]||"");F(a)}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Serial Numbers (Optional - ",v.filter(s=>s.trim()).length," of ",g," filled)"]}),g>10&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-2 mb-2",children:e.jsx("p",{className:"text-sm text-yellow-700",children:"Large quantity detected. Consider using batch serial number format or leave empty for auto-generation."})}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded p-3 bg-gray-50",style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsx("div",{className:"space-y-2",children:Array.from({length:g},(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-8 flex-shrink-0",children:["#",t+1]}),e.jsx(k,{type:"text",placeholder:`Serial number ${t+1}`,value:v[t]||"",onChange:a=>{const D=[...v];D[t]=a.target.value,F(D)},className:"flex-1",size:"sm"})]},t))})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Leave empty for non-serialized items. Scroll within the box above for many items."})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t flex-shrink-0",children:[e.jsx(n,{variant:"plain",onClick:S,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:Ce,loading:X.isLoading,icon:e.jsx(_e,{}),children:"Add Stock"})]})]})]})}),e.jsxs(L,{isOpen:ue,onClose:y,onRequestClose:y,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(N,{value:{value:h,label:h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>Q(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:y,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:ke,loading:V.isLoading,icon:e.jsx(qe,{}),children:"Confirm Return"})]})]})]})]})},We=()=>{const C=re();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(n,{variant:"solid",size:"sm",icon:e.jsx(Me,{}),onClick:()=>C("/products/create"),children:"Add Product"})})},Os=()=>e.jsxs(Pe,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(We,{})]}),e.jsx(Ue,{})]});export{Os as default};
