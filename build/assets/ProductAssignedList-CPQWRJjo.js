import{r as o,J as V,T as J,j as e}from"./index-CRLhe4UJ.js";import{A as U}from"./AdaptableCard-D8XU8xvv.js";import"./Views-kvwvgnoa.js";import{S as I}from"./index-BPAnroHB.js";import"./chart.config-BGCa2kC1.js";import"./index-B8bJU2zV.js";import{B as a}from"./Button-8wmeFP59.js";import{t as k,N as R,D as E}from"./Upload-BsdIaWhn.js";import{D as K}from"./DataTable-JOkbz8-7.js";import{I as W}from"./hoist-non-react-statics.cjs-h-IznSOP.js";import"./SvgIcon-8VoSlnHa.js";import{y as X,J as Y,C as L,D as _,v as Z}from"./index-IkMseqAw.js";import{u as ee}from"./useQuery-x5c111Hj.js";import{u as p}from"./useMutation-DBwMoqdm.js";import{d as te}from"./debounce-CSE1FzzO.js";import{h as ne,r as se,n as ie,b as ae}from"./ProductService-DuAS4pFV.js";import"./Alert-DqTPxGto.js";import"./Card-C9ZImza0.js";import"./index-B0PN-9QH.js";import"./index-BnYNxHWj.js";import"./index-CT8fCIvY.js";import"./ScrollBar-Bv1uJUI5.js";import{b as oe}from"./index-B19ZLQ2T.js";import"./index-Chjiymov.js";import"./toString-D-v_3TrA.js";import"./CloseButton-3K3Gy7SU.js";import"./cloneDeep-DJN0yfLA.js";import"./useThemeClass-DxmkPlTx.js";import"./_getPrototype-xGtM0kyU.js";const re=()=>{var w,S,D;const O=o.useRef(null),v=V(),f=J(),[j,P]=o.useState(""),[c,h]=o.useState({page:1,limit:10}),[x,Q]=o.useState(!1),[s,u]=o.useState({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"}),[r,d]=o.useState({open:!1,assignment:null}),{data:l,isLoading:F,error:y,refetch:T}=ee({queryKey:["active-assignments",c,j,x],queryFn:()=>ae({page:c.page,limit:c.limit,search:j,overdue:x})}),b=p({mutationFn:t=>ne(t.assignmentId,{condition:t.condition,notes:t.notes,inventoryStatus:t.inventoryStatus}),onSuccess:()=>{m("Product returned successfully","success"),f.invalidateQueries(["active-assignments"]),g()},onError:t=>{var n,i;m(((i=(n=t.response)==null?void 0:n.data)==null?void 0:i.message)||"Failed to return product","danger")}}),N=p({mutationFn:se,onSuccess:()=>{m("Assignment deleted successfully","success"),f.invalidateQueries(["active-assignments"]),d({open:!1,assignment:null})},onError:t=>{var n,i;m(((i=(n=t.response)==null?void 0:n.data)==null?void 0:i.message)||"Failed to delete assignment","danger")}}),{mutate:C,isPending:A}=p({mutationFn:async t=>{var i;const n=await ie(t);if(!((i=n.data)!=null&&i.qrCode))throw new Error("Invalid QR code data received from server");return{qrCode:n.data.qrCode,assignmentInfo:n.data.assignmentInfo}},onSuccess:t=>{z(t.qrCode,t.assignmentInfo)},onError:t=>{k.push(e.jsx(R,{title:"Error",type:"danger",children:t.message||"Failed to generate assignment QR code"}))}}),m=(t,n)=>{k.push(e.jsx(R,{title:n==="success"?"Success":"Error",type:n,children:t}))},q=o.useMemo(()=>te(t=>{P(t),h(n=>({...n,page:1}))},500),[]),g=()=>{u({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"})},G=t=>{u({...s,open:!0,assignment:{id:t.id,productName:t.product.name,inventoryInfo:t.inventory.serialNumber||`Item #${t.inventory.id}`}})},M=t=>{d({open:!0,assignment:{id:t.id,productName:t.product.name,employeeName:t.employee.name}})},$=async()=>{var t;(t=r.assignment)!=null&&t.id&&await N.mutateAsync(r.assignment.id)},B=async()=>{var t;if(!((t=s.assignment)!=null&&t.id)){m("No valid assignment selected","danger");return}await b.mutateAsync({assignmentId:s.assignment.id,condition:s.condition,inventoryStatus:s.inventoryStatus,notes:`Returned in ${s.condition.toLowerCase()} condition. Inventory status: ${s.inventoryStatus.toLowerCase()}`})},z=(t,n)=>{const i=window.open("","_blank","width=600,height=700");i&&(i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Assignment QR Code - ${n.productName}</title>
            <style>
              body { 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              }
              .qr-container {
                margin: 20px auto;
                width: 300px;
                height: 300px;
              }
              .assignment-info {
                margin-bottom: 20px;
                text-align: left;
              }
              .info-row {
                margin-bottom: 8px;
              }
              img { width: 100%; height: auto; }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <img src="${t}" alt="Assignment QR Code" />
            </div>
         
          </body>
        </html>
      `),i.document.close())},H=o.useMemo(()=>[{header:"Product",cell:t=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold block",children:t.row.original.product.name}),e.jsx("span",{className:"text-xs text-gray-500",children:t.row.original.product.model})]})},{header:"Inventory Item",cell:t=>e.jsxs("div",{children:[e.jsx("span",{className:"block",children:t.row.original.inventory.serialNumber||`Item #${t.row.original.inventory.id}`}),e.jsx("div",{className:"text-xs text-gray-700 mt-1",children:t.row.original.inventory.condition})]})},{header:"Category",cell:t=>t.row.original.product.category.name},{header:"Branch",cell:t=>t.row.original.product.branch.name},{header:"Assigned To",cell:t=>e.jsxs("div",{children:[e.jsx("span",{className:"block",children:t.row.original.employee.name}),e.jsx("span",{className:"text-xs text-gray-500",children:t.row.original.employee.empId})]})},{header:"Assigned On",cell:t=>new Date(t.row.original.assignedAt).toLocaleDateString()},{header:"Actions",id:"action",cell:t=>{const n=t.row.original;return e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(a,{size:"xs",icon:e.jsx(X,{}),onClick:()=>v(`/assignments/${n.id}`),title:"View Product"}),e.jsx(a,{size:"xs",variant:"twoTone",icon:e.jsx(Y,{}),onClick:()=>C(n.id),loading:A,title:"Generate QR Code"}),e.jsx(a,{size:"xs",variant:"solid",icon:e.jsx(oe,{}),onClick:()=>G(n),children:"Return"}),e.jsx(a,{size:"xs",variant:"solid",color:"red",icon:e.jsx(L,{}),onClick:()=>M(n),title:"Delete Assignment"})]})}}],[v,C,A]);return y?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",y.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(W,{placeholder:"Search assignments...",onChange:t=>q(t.target.value),className:"max-w-md"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"overdue-filter",checked:x,onChange:t=>Q(t.target.checked),className:"rounded"}),e.jsx("label",{htmlFor:"overdue-filter",className:"text-sm",children:"Show overdue only"})]})]}),e.jsx(a,{icon:e.jsx(_,{}),onClick:()=>T(),children:"Refresh"})]}),e.jsx(K,{ref:O,columns:H,data:((w=l==null?void 0:l.data)==null?void 0:w.data)||[],loading:F,pagingData:{total:((D=(S=l==null?void 0:l.data)==null?void 0:S.pagination)==null?void 0:D.total)||0,pageIndex:c.page,pageSize:c.limit},onPaginationChange:t=>h(n=>({...n,page:t})),onSelectChange:t=>h({page:1,limit:t})}),e.jsxs(E,{isOpen:s.open,onClose:g,onRequestClose:g,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),s.assignment&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:s.assignment.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Item"}),e.jsx("p",{className:"text-gray-600",children:s.assignment.inventoryInfo})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Return Condition"}),e.jsx(I,{value:{value:s.condition,label:s.condition.charAt(0).toUpperCase()+s.condition.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:t=>u({...s,condition:t.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Status After Return"}),e.jsx(I,{value:{value:s.inventoryStatus,label:s.inventoryStatus.charAt(0).toUpperCase()+s.inventoryStatus.slice(1).toLowerCase()},options:[{value:"AVAILABLE",label:"Available"},{value:"MAINTENANCE",label:"Needs Maintenance"},{value:"DAMAGED",label:"Damaged"}],onChange:t=>u({...s,inventoryStatus:t.value})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Choose the status for the inventory item after return"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(a,{variant:"plain",onClick:g,children:"Cancel"}),e.jsx(a,{variant:"solid",onClick:B,loading:b.isLoading,icon:e.jsx(Z,{}),children:"Confirm Return"})]})]})]}),e.jsxs(E,{isOpen:r.open,onClose:()=>d({open:!1,assignment:null}),onRequestClose:()=>d({open:!1,assignment:null}),width:400,children:[e.jsx("h4",{className:"mb-4",children:"Delete Assignment"}),r.assignment&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600",children:"Are you sure you want to delete this assignment?"}),e.jsxs("div",{className:"bg-red-50 p-3 rounded-md",children:[e.jsx("p",{className:"font-semibold text-red-700",children:r.assignment.productName}),e.jsxs("p",{className:"text-red-600 text-sm",children:["Assigned to: ",r.assignment.employeeName]})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"This action will return the inventory item to available stock and cannot be undone."}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(a,{variant:"plain",onClick:()=>d({open:!1,assignment:null}),children:"Cancel"}),e.jsx(a,{variant:"solid",color:"red",onClick:$,loading:N.isLoading,icon:e.jsx(L,{}),children:"Delete Assignment"})]})]})]})]})},Te=()=>e.jsxs(U,{className:"h-full",bodyClass:"h-full",children:[e.jsx("div",{className:"lg:flex items-center justify-between mb-4",children:e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Product Assignments"})}),e.jsx(re,{})]});export{Te as default};
