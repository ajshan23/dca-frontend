import{r as a,J as T,T as G,j as t}from"./index-raIB5kr7.js";import{A as B}from"./AdaptableCard-CDwsXtTH.js";import"./Views-CqvteLF_.js";import{S as N}from"./index-iyOQ0Qo2.js";import"./chart.config-DJqIkkyf.js";import"./index-DV_E7KAf.js";import{B as r}from"./Button-93EWxRqP.js";import{t as w,N as A,D as M}from"./Upload-DSzpuZCv.js";import{D as $}from"./DataTable-j9hyLV9K.js";import{I as z}from"./hoist-non-react-statics.cjs-B1VVJCv9.js";import"./SvgIcon-BdIHRtoz.js";import{w as H,J as V,D as J,v as U}from"./index-YT-1x9V6.js";import{u as K}from"./useQuery-BimGM40F.js";import{u as S}from"./useMutation-CVof13mL.js";import{d as W}from"./debounce-D3IksEUc.js";import{h as X,n as Y,b as _}from"./ProductService-BdWVaAcP.js";import"./Alert-mfcoSqqP.js";import"./Card-3F_r41t5.js";import"./index-BKNK5kOs.js";import"./index-BtQogmgw.js";import"./index-BzxDl7Rk.js";import"./Progress-CjK2z3SZ.js";import"./ScrollBar-yL4Snvlg.js";import{b as Z}from"./index-DLWYlJg8.js";import"./index-Chjiymov.js";import"./toString-BfPUnzgJ.js";import"./CloseButton-C3OzjHaP.js";import"./cloneDeep-DJN0yfLA.js";import"./useThemeClass-NOO-mIIF.js";import"./_getPrototype-Bc5S2B2d.js";const ee=()=>{var y,b,C;const I=a.useRef(null),h=T(),R=G(),[x,E]=a.useState(""),[l,m]=a.useState({page:1,limit:10}),[u,k]=a.useState(!1),[n,c]=a.useState({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"}),{data:o,isLoading:D,error:p,refetch:L}=K({queryKey:["active-assignments",l,x,u],queryFn:()=>_({page:l.page,limit:l.limit,search:x,overdue:u})}),v=S({mutationFn:e=>X(e.assignmentId,{condition:e.condition,notes:e.notes,inventoryStatus:e.inventoryStatus}),onSuccess:()=>{g("Product returned successfully","success"),R.invalidateQueries(["active-assignments"]),d()},onError:e=>{var s,i;g(((i=(s=e.response)==null?void 0:s.data)==null?void 0:i.message)||"Failed to return product","danger")}}),{mutate:f,isPending:j}=S({mutationFn:async e=>{var i;const s=await Y(e);if(!((i=s.data)!=null&&i.qrCode))throw new Error("Invalid QR code data received from server");return{qrCode:s.data.qrCode,assignmentInfo:s.data.assignmentInfo}},onSuccess:e=>{F(e.qrCode,e.assignmentInfo)},onError:e=>{w.push(t.jsx(A,{title:"Error",type:"danger",children:e.message||"Failed to generate assignment QR code"}))}}),g=(e,s)=>{w.push(t.jsx(A,{title:s==="success"?"Success":"Error",type:s,children:e}))},O=a.useMemo(()=>W(e=>{E(e),m(s=>({...s,page:1}))},500),[]),d=()=>{c({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"})},P=e=>{c({...n,open:!0,assignment:{id:e.id,productName:e.product.name,inventoryInfo:e.inventory.serialNumber||`Item #${e.inventory.id}`}})},Q=async()=>{var e;if(!((e=n.assignment)!=null&&e.id)){g("No valid assignment selected","danger");return}await v.mutateAsync({assignmentId:n.assignment.id,condition:n.condition,inventoryStatus:n.inventoryStatus,notes:`Returned in ${n.condition.toLowerCase()} condition. Inventory status: ${n.inventoryStatus.toLowerCase()}`})},F=(e,s)=>{const i=window.open("","_blank","width=600,height=700");i&&(i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Assignment QR Code - ${s.productName}</title>
            <style>
              body { 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              }
              .qr-container {
                margin: 20px auto;
                width: 300px;
                height: 300px;
              }
              .assignment-info {
                margin-bottom: 20px;
                text-align: left;
              }
              .info-row {
                margin-bottom: 8px;
              }
              img { width: 100%; height: auto; }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <img src="${e}" alt="Assignment QR Code" />
            </div>
         
          </body>
        </html>
      `),i.document.close())},q=a.useMemo(()=>[{header:"Product",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold block",children:e.row.original.product.name}),t.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.product.model})]})},{header:"Inventory Item",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"block",children:e.row.original.inventory.serialNumber||`Item #${e.row.original.inventory.id}`}),t.jsx("div",{className:"text-xs text-gray-700 mt-1",children:e.row.original.inventory.condition})]})},{header:"Category",cell:e=>e.row.original.product.category.name},{header:"Branch",cell:e=>e.row.original.product.branch.name},{header:"Assigned To",cell:e=>t.jsxs("div",{children:[t.jsx("span",{className:"block",children:e.row.original.employee.name}),t.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.employee.empId})]})},{header:"Assigned By",cell:e=>e.row.original.assignedBy.username},{header:"Assigned At",cell:e=>new Date(e.row.original.assignedAt).toLocaleDateString()},{header:"Actions",id:"action",cell:e=>{const s=e.row.original;return t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(r,{size:"xs",icon:t.jsx(H,{}),onClick:()=>h(`/products/view/${s.product.id}`),title:"View Product"}),t.jsx(r,{size:"xs",variant:"twoTone",icon:t.jsx(V,{}),onClick:()=>f(s.id),loading:j,title:"Generate QR Code"}),t.jsx(r,{size:"xs",variant:"solid",icon:t.jsx(Z,{}),onClick:()=>P(s),children:"Return"})]})}}],[h,f,j]);return p?t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsxs("span",{className:"text-red-500",children:["Error: ",p.message]})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[t.jsxs("div",{className:"flex gap-4 flex-1",children:[t.jsx(z,{placeholder:"Search assignments...",onChange:e=>O(e.target.value),className:"max-w-md"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",id:"overdue-filter",checked:u,onChange:e=>k(e.target.checked),className:"rounded"}),t.jsx("label",{htmlFor:"overdue-filter",className:"text-sm",children:"Show overdue only"})]})]}),t.jsx(r,{icon:t.jsx(J,{}),onClick:()=>L(),children:"Refresh"})]}),t.jsx($,{ref:I,columns:q,data:((y=o==null?void 0:o.data)==null?void 0:y.data)||[],loading:D,pagingData:{total:((C=(b=o==null?void 0:o.data)==null?void 0:b.pagination)==null?void 0:C.total)||0,pageIndex:l.page,pageSize:l.limit},onPaginationChange:e=>m(s=>({...s,page:e})),onSelectChange:e=>m({page:1,limit:e})}),t.jsxs(M,{isOpen:n.open,onClose:d,onRequestClose:d,width:500,children:[t.jsx("h4",{className:"mb-4",children:"Return Product"}),n.assignment&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),t.jsx("p",{className:"font-semibold",children:n.assignment.productName})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Item"}),t.jsx("p",{className:"text-gray-600",children:n.assignment.inventoryInfo})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Return Condition"}),t.jsx(N,{value:{value:n.condition,label:n.condition.charAt(0).toUpperCase()+n.condition.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:e=>c({...n,condition:e.value})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Status After Return"}),t.jsx(N,{value:{value:n.inventoryStatus,label:n.inventoryStatus.charAt(0).toUpperCase()+n.inventoryStatus.slice(1).toLowerCase()},options:[{value:"AVAILABLE",label:"Available"},{value:"MAINTENANCE",label:"Needs Maintenance"},{value:"DAMAGED",label:"Damaged"}],onChange:e=>c({...n,inventoryStatus:e.value})}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Choose the status for the inventory item after return"})]}),t.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[t.jsx(r,{variant:"plain",onClick:d,children:"Cancel"}),t.jsx(r,{variant:"solid",onClick:Q,loading:v.isLoading,icon:t.jsx(U,{}),children:"Confirm Return"})]})]})]})]})},De=()=>t.jsxs(B,{className:"h-full",bodyClass:"h-full",children:[t.jsx("div",{className:"lg:flex items-center justify-between mb-4",children:t.jsx("h3",{className:"mb-4 lg:mb-0",children:"Product Assignments"})}),t.jsx(ee,{})]});export{De as default};
