import{r as l,J as be,T as Ge,j as e}from"./index-BzHZzxX0.js";import{A as _e}from"./AdaptableCard-BjkToBNq.js";import"./Views-tZVvsZbt.js";import{S as P}from"./index-B6q6Ul9Z.js";import"./chart.config-B09BqGbe.js";import"./index-ClV6Y1xO.js";import{B as i}from"./Button-B_bo9BV3.js";import{D as E,t as r,N as o}from"./Upload-BvyCkGyN.js";import{D as Ke}from"./DataTable-B6Y_J6Jy.js";import{I as y}from"./hoist-non-react-statics.cjs-CmBnlRmG.js";import"./SvgIcon-Bu-sPLVq.js";import{w as Je,x as Ue,A as We,B as Ve,C as Xe,D as Ye,E as z,v as ge,z as Ze}from"./index-DtRuNtK-.js";import{u as es}from"./useThemeClass-CizYVZJy.js";import{u as ve}from"./useQuery-CY7cJG4M.js";import{u as D}from"./useMutation-BbgW7Xkb.js";import{d as je}from"./debounce-DdBoVYyJ.js";import{d as ss,e as ts,f as as,g as ls,h as ns,i as is}from"./ProductService-CePMFLAp.js";import{a as rs}from"./EmployeeService.ts-IMUf-NgO.js";import"./Alert-lec3Bq8o.js";import"./Card-CMjPz5hL.js";import"./index-VZ3FPubS.js";import"./index-AlTq7Jqu.js";import"./index-BaoGZ968.js";import"./Progress-CEKx0qSC.js";import"./ScrollBar-DbInVHFp.js";import{B as os}from"./index-D8t1U86h.js";import"./index-Chjiymov.js";import"./toString-DKANHZ97.js";import"./CloseButton-Cmt1tiqF.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-BGPo7mUk.js";const cs=()=>{var de,me,ue,xe,he,pe;const I=l.useRef(null),F=be(),N=Ge(),{textTheme:fe}=es(),[L,ye]=l.useState(null),[H,Ne]=l.useState(""),[h,S]=l.useState({page:1,limit:10}),[p,Se]=l.useState(""),[B,Q]=l.useState(!1),[ke,Ce]=l.useState(!1),[Ae,$]=l.useState(!1),[we,G]=l.useState(!1),[c,k]=l.useState(null),[n,_]=l.useState(null),[d,Oe]=l.useState(null),[m,K]=l.useState(null),[T,Pe]=l.useState(null),[J,U]=l.useState(""),[W,V]=l.useState(""),[g,X]=l.useState("GOOD"),[R,M]=l.useState([]),[v,Y]=l.useState(null),[j,Z]=l.useState(1),[b,q]=l.useState([""]),[ee,se]=l.useState("");l.useEffect(()=>{const s=localStorage.getItem("user");if(s)try{console.log(JSON.parse(s)),ye(JSON.parse(s))}catch(t){console.error("Error parsing user data:",t)}},[]);const{data:u,isLoading:Ee,error:te,refetch:De}=ve({queryKey:["products",h,H,p],queryFn:()=>is({page:h.page,limit:h.limit,search:H,stockStatus:p||void 0}),keepPreviousData:!0}),{data:f,refetch:ms}=ve({queryKey:["employees-for-assignment",ee],queryFn:()=>rs({page:1,limit:100,search:ee}),enabled:B}),ae=D({mutationFn:as,onSuccess:()=>{r.push(e.jsx(o,{title:"Success",type:"success",children:"Product assigned successfully"})),N.invalidateQueries(["products"]),C()},onError:s=>{var t,a;r.push(e.jsx(o,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),le=D({mutationFn:s=>ns(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{r.push(e.jsx(o,{title:"Success",type:"success",children:"Product returned successfully"})),N.invalidateQueries(["products"]),A()},onError:s=>{var t,a;r.push(e.jsx(o,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),ne=D({mutationFn:s=>ls(s.productId,s.stockData),onSuccess:s=>{var t;r.push(e.jsx(o,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),N.invalidateQueries(["products"]),w()},onError:s=>{var t,a;r.push(e.jsx(o,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),ie=D({mutationFn:ts,onSuccess:s=>{var t;r.push(e.jsx(o,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Product deleted successfully"})),N.invalidateQueries(["products"]),O()},onError:s=>{var t,a;r.push(e.jsx(o,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to delete product"}))}}),Ie=l.useMemo(()=>je(s=>{Ne(s),S(t=>({...t,page:1}))},500),[]),Fe=l.useMemo(()=>je(s=>{se(s)},300),[]),C=()=>{k(null),K(null),Y(null),Pe(null),U(""),V(""),M([]),se(""),Q(!1)},A=()=>{Oe(null),X("GOOD"),Ce(!1)},w=()=>{k(null),Z(1),q([""]),$(!1)},O=()=>{_(null),G(!1)},Le=async s=>{var t;k({id:s.id,name:s.name});try{const a=await ss(s.id);M(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),M([])}Q(!0)},Te=s=>{k({id:s.id,name:s.name}),$(!0)},Re=s=>{const t=s.stockInfo.totalStock>0,a=s.stockInfo.assignedStock>0;_({id:s.id,name:s.name,model:s.model,hasStock:t,hasActiveAssignments:a}),G(!0)},Me=async()=>{!c||!m||await ae.mutateAsync({productId:c.id,employeeId:m,inventoryId:v||void 0,expectedReturnAt:T==null?void 0:T.toISOString(),notes:J,pcName:W.trim()||void 0,autoSelect:!v})},qe=async()=>{if(!(d!=null&&d.id)){r.push(e.jsx(o,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await le.mutateAsync({assignmentId:d.id,condition:g,notes:`Returned in ${g.toLowerCase()} condition`})},ze=async()=>{if(!c)return;const s={quantity:j,serialNumbers:b.filter(t=>t.trim()),reason:"Stock replenishment"};await ne.mutateAsync({productId:c.id,stockData:s})},He=async()=>{if(!(n!=null&&n.id)){r.push(e.jsx(o,{title:"Error",type:"danger",children:"No product selected for deletion"}));return}await ie.mutateAsync(n.id)},re=l.useMemo(()=>{var s,t;return((t=(s=f==null?void 0:f.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId}) - ${a.department}`,employee:a})))||[]},[f]),oe=l.useMemo(()=>R.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[R]),ce=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],Be=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx("div",{className:"text-red-600 px-2 py-1 rounded text-sm",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs("div",{className:"text-yellow-600  px-2 py-1 rounded text-sm",children:["Low Stock (",a,")"]});default:return e.jsxs("div",{className:"text-green-600  px-2 py-1 rounded text-sm",children:["Available (",a,")"]})}},Qe=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[Be(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx("div",{className:s.row.original.complianceStatus?"text-green-600 px-2 py-1 rounded text-sm":"text-red-600  px-2 py-1 rounded text-sm",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0,x=t.stockInfo.assignedStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-1",children:[e.jsx(i,{size:"xs",icon:e.jsx(Je,{}),onClick:()=>F(`/products/view/${t.id}`),title:"View Product"}),e.jsx(i,{size:"xs",icon:e.jsx(Ue,{}),onClick:()=>F(`/products/edit/${t.id}`),title:"Edit Product"}),e.jsx(i,{size:"xs",icon:e.jsx(We,{}),onClick:()=>Te(t),variant:"twoTone",title:"Add Stock",children:"Stock"}),a?e.jsx(i,{size:"xs",icon:e.jsx(Ve,{}),onClick:()=>Le(t),variant:"solid",title:"Assign Product",children:"Assign"}):e.jsx(i,{size:"xs",disabled:!0,variant:"plain",title:"No stock available",children:"No Stock"}),(L==null?void 0:L.role)==="super_admin"&&e.jsx(i,{size:"xs",icon:e.jsx(Xe,{}),onClick:()=>Re(t),variant:"plain",className:"text-red-600 hover:text-red-800 hover:bg-red-50",title:x?"Cannot delete - has active assignments":"Delete Product",disabled:x,children:"Delete"})]})}}],[F,fe]);return te?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",te.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(y,{placeholder:"Search products...",onChange:s=>Ie(s.target.value),className:"max-w-md"}),e.jsx(P,{placeholder:"Filter by stock",options:ce,value:p?{value:p,label:(de=ce.find(s=>s.value===p))==null?void 0:de.label}:null,onChange:s=>{Se((s==null?void 0:s.value)||""),S(t=>({...t,page:1}))},className:"min-w-[200px]",isClearable:!0})]}),e.jsx(i,{icon:e.jsx(Ye,{}),onClick:()=>De(),children:"Refresh"})]}),e.jsx(Ke,{ref:I,columns:Qe,data:((me=u==null?void 0:u.data)==null?void 0:me.data)||[],loading:Ee,pagingData:{total:((xe=(ue=u==null?void 0:u.data)==null?void 0:ue.pagination)==null?void 0:xe.total)||0,pageIndex:h.page,pageSize:h.limit},onPaginationChange:s=>S(t=>({...t,page:s})),onSelectChange:s=>S({page:1,limit:s})}),e.jsx(E,{isOpen:we,onClose:O,onRequestClose:O,width:500,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4",children:e.jsx(z,{className:"h-6 w-6 text-red-600"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Delete Product"}),n&&e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Are you sure you want to delete this product? This action cannot be undone."}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"text-left space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Product:"}),e.jsx("span",{className:"ml-2",children:n.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Model:"}),e.jsx("span",{className:"ml-2",children:n.model})]})]})}),n.hasActiveAssignments&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(z,{className:"h-5 w-5 text-red-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Cannot Delete Product"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:"This product has active assignments and cannot be deleted. Please return all assigned items before deletion."})})]})]})}),n.hasStock&&!n.hasActiveAssignments&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(z,{className:"h-5 w-5 text-yellow-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Warning: Product Has Inventory"}),e.jsx("div",{className:"mt-2 text-sm text-yellow-700",children:e.jsx("p",{children:"This product has inventory items. Deleting will also remove all associated inventory records."})})]})]})}),!n.hasStock&&!n.hasActiveAssignments&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-md p-3 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(ge,{className:"h-5 w-5 text-green-400"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-green-800",children:"Safe to Delete"}),e.jsx("div",{className:"mt-2 text-sm text-green-700",children:e.jsx("p",{children:"This product has no inventory or active assignments."})})]})]})})]}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(i,{variant:"plain",onClick:O,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:He,loading:ie.isLoading,disabled:n==null?void 0:n.hasActiveAssignments,className:"bg-red-600 hover:bg-red-700 text-white",children:n!=null&&n.hasActiveAssignments?"Cannot Delete":"Delete Product"})]})]})}),e.jsxs(E,{isOpen:B,onClose:C,onRequestClose:C,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(P,{placeholder:"Search and select employee",options:re,value:m?{value:m,label:(he=re.find(s=>s.value===m))==null?void 0:he.label}:null,onChange:s=>K(s==null?void 0:s.value),onInputChange:s=>Fe(s),isSearchable:!0,isLoading:!f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Type to search employees by name, ID, or email"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"PC Name (Optional)"}),e.jsx(y,{type:"text",value:W,onChange:s=>V(s.target.value),placeholder:"Enter pc name",maxLength:50}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Enter the PC  identifier for tracking purposes"})]}),R.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(P,{placeholder:"Auto-select available item",options:oe,value:v?{value:v,label:(pe=oe.find(s=>s.value===v))==null?void 0:pe.label}:null,onChange:s=>Y(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(y,{type:"text",value:J,onChange:s=>U(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:C,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:Me,loading:ae.isLoading,disabled:!m,children:"Confirm Assignment"})]})]})]}),e.jsx(E,{isOpen:Ae,onClose:w,onRequestClose:w,width:500,children:e.jsxs("div",{className:"max-h-[80vh] flex flex-col",children:[e.jsx("h4",{className:"mb-4 flex-shrink-0",children:"Add Stock"}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto pr-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(y,{type:"number",min:"1",max:"100",value:j,onChange:s=>{const t=Number(s.target.value);Z(t);const a=Array.from({length:t},(x,$e)=>b[$e]||"");q(a)}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Serial Numbers (Optional - ",b.filter(s=>s.trim()).length," of ",j," filled)"]}),j>10&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-2 mb-2",children:e.jsx("p",{className:"text-sm text-yellow-700",children:"Large quantity detected. Consider using batch serial number format or leave empty for auto-generation."})}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded p-3 bg-gray-50",style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsx("div",{className:"space-y-2",children:Array.from({length:j},(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-8 flex-shrink-0",children:["#",t+1]}),e.jsx(y,{type:"text",placeholder:`Serial number ${t+1}`,value:b[t]||"",onChange:a=>{const x=[...b];x[t]=a.target.value,q(x)},className:"flex-1",size:"sm"})]},t))})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Leave empty for non-serialized items. Scroll within the box above for many items."})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t flex-shrink-0",children:[e.jsx(i,{variant:"plain",onClick:w,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:ze,loading:ne.isLoading,icon:e.jsx(os,{}),children:"Add Stock"})]})]})]})}),e.jsxs(E,{isOpen:ke,onClose:A,onRequestClose:A,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:d.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(P,{value:{value:g,label:g.charAt(0).toUpperCase()+g.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>X(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:A,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:qe,loading:le.isLoading,icon:e.jsx(ge,{}),children:"Confirm Return"})]})]})]})]})},ds=()=>{const I=be();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(i,{variant:"solid",size:"sm",icon:e.jsx(Ze,{}),onClick:()=>I("/products/create"),children:"Add Product"})})},$s=()=>e.jsxs(_e,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(ds,{})]}),e.jsx(cs,{})]});export{$s as default};
