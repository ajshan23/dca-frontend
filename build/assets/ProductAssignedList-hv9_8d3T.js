import{r as a,J as K,T as W,U as X,V as Y,j as s}from"./index-TEH5dBCx.js";import{A as Z}from"./AdaptableCard-gXf7GmI6.js";import"./Views-DMwcHtdt.js";import{S as k}from"./index-McEAQz1s.js";import"./chart.config-wVxolKoX.js";import"./index-OS1leKni.js";import{B as o}from"./Button-BUzKSCMu.js";import{t as O,N as P,D as L}from"./Upload-e7Mj5fP7.js";import{D as ee}from"./DataTable-BCgO2BLt.js";import{I as se}from"./hoist-non-react-statics.cjs-DWnuqmCi.js";import"./SvgIcon-nhUS7VPd.js";import{y as te,J as ne,C as Q,D as ie,v as ae}from"./index-DexGGemz.js";import{u as oe}from"./useQuery-B_1zV9qe.js";import{u as f}from"./useMutation-DS0QITqb.js";import{d as re}from"./debounce-rBX5poEG.js";import{h as le,r as ce,n as de,b as me}from"./ProductService-b_0bMy20.js";import"./Alert-p0GbirZ_.js";import"./Card-Dhe7HhRs.js";import"./index-suFKXivx.js";import"./index-DeR0D_24.js";import"./index-CO7yGqxa.js";import"./ScrollBar-D_OdJclh.js";import{b as ue}from"./index-D7aOIQFn.js";import"./index-Chjiymov.js";import"./toString-UKiOXWKD.js";import"./CloseButton-DFP83YRg.js";import"./cloneDeep-DJN0yfLA.js";import"./useThemeClass-CSXPPH7w.js";import"./_getPrototype-oH1nSSDt.js";const ge=()=>{var I,D,R;const T=a.useRef(null),j=K(),y=W(),[b,F]=a.useState(""),[c,p]=a.useState({page:1,limit:10}),[x,q]=a.useState(!1),[u,M]=a.useState(null),[n,g]=a.useState({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"}),[r,d]=a.useState({open:!1,assignment:null});a.useEffect(()=>{var E;const e=localStorage.getItem(X),t=Y(e);console.log("Raw persist data:",e),console.log("Parsed persist data:",t);let i=(E=t==null?void 0:t.auth)==null?void 0:E.session;console.log("Session from persist data:",i),i?M(i):console.warn("No session found in persist data")},[]);const{data:l,isLoading:G,error:N,refetch:$}=oe({queryKey:["active-assignments",c,b,x],queryFn:()=>me({page:c.page,limit:c.limit,search:b,overdue:x})}),C=f({mutationFn:e=>le(e.assignmentId,{condition:e.condition,notes:e.notes,inventoryStatus:e.inventoryStatus}),onSuccess:()=>{m("Product returned successfully","success"),y.invalidateQueries(["active-assignments"]),h()},onError:e=>{var t,i;m(((i=(t=e.response)==null?void 0:t.data)==null?void 0:i.message)||"Failed to return product","danger")}}),A=f({mutationFn:ce,onSuccess:()=>{m("Assignment deleted successfully","success"),y.invalidateQueries(["active-assignments"]),d({open:!1,assignment:null})},onError:e=>{var t,i;m(((i=(t=e.response)==null?void 0:t.data)==null?void 0:i.message)||"Failed to delete assignment","danger")}}),{mutate:w,isPending:S}=f({mutationFn:async e=>{var i;const t=await de(e);if(!((i=t.data)!=null&&i.qrCode))throw new Error("Invalid QR code data received from server");return{qrCode:t.data.qrCode,assignmentInfo:t.data.assignmentInfo}},onSuccess:e=>{J(e.qrCode,e.assignmentInfo)},onError:e=>{O.push(s.jsx(P,{title:"Error",type:"danger",children:e.message||"Failed to generate assignment QR code"}))}}),m=(e,t)=>{O.push(s.jsx(P,{title:t==="success"?"Success":"Error",type:t,children:e}))},B=a.useMemo(()=>re(e=>{F(e),p(t=>({...t,page:1}))},500),[]),h=()=>{g({open:!1,assignment:null,condition:"GOOD",inventoryStatus:"AVAILABLE"})},z=e=>{g({...n,open:!0,assignment:{id:e.id,productName:e.product.name,inventoryInfo:e.inventory.serialNumber||`Item #${e.inventory.id}`}})},H=e=>{d({open:!0,assignment:{id:e.id,productName:e.product.name,employeeName:e.employee.name}})},V=async()=>{var e;(e=r.assignment)!=null&&e.id&&await A.mutateAsync(r.assignment.id)},_=async()=>{var e;if(!((e=n.assignment)!=null&&e.id)){m("No valid assignment selected","danger");return}await C.mutateAsync({assignmentId:n.assignment.id,condition:n.condition,inventoryStatus:n.inventoryStatus,notes:`Returned in ${n.condition.toLowerCase()} condition. Inventory status: ${n.inventoryStatus.toLowerCase()}`})},J=(e,t)=>{const i=window.open("","_blank","width=600,height=700");i&&(i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Assignment QR Code - ${t.productName}</title>
            <style>
              body { 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              }
              .qr-container {
                margin: 20px auto;
                width: 300px;
                height: 300px;
              }
              .assignment-info {
                margin-bottom: 20px;
                text-align: left;
              }
              .info-row {
                margin-bottom: 8px;
              }
              img { width: 100%; height: auto; }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <img src="${e}" alt="Assignment QR Code" />
            </div>
         
          </body>
        </html>
      `),i.document.close())},v=(u==null?void 0:u.role)==="super_admin";console.log("Current user:",u),console.log("Is super admin:",v);const U=a.useMemo(()=>[{header:"Product",cell:e=>s.jsxs("div",{children:[s.jsx("span",{className:"font-semibold block",children:e.row.original.product.name}),s.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.product.model})]})},{header:"Inventory Item",cell:e=>s.jsxs("div",{children:[s.jsx("span",{className:"block",children:e.row.original.inventory.serialNumber||`Item #${e.row.original.inventory.id}`}),s.jsx("div",{className:"text-xs text-gray-700 mt-1",children:e.row.original.inventory.condition})]})},{header:"Category",cell:e=>e.row.original.product.category.name},{header:"Branch",cell:e=>e.row.original.product.branch.name},{header:"Assigned To",cell:e=>s.jsxs("div",{children:[s.jsx("span",{className:"block",children:e.row.original.employee.name}),s.jsx("span",{className:"text-xs text-gray-500",children:e.row.original.employee.empId})]})},{header:"Assigned On",cell:e=>new Date(e.row.original.assignedAt).toLocaleDateString()},{header:"Actions",id:"action",cell:e=>{const t=e.row.original;return s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(o,{size:"xs",icon:s.jsx(te,{}),onClick:()=>j(`/assignments/${t.id}`),title:"View Product"}),s.jsx(o,{size:"xs",variant:"twoTone",icon:s.jsx(ne,{}),onClick:()=>w(t.id),loading:S,title:"Generate QR Code"}),s.jsx(o,{size:"xs",variant:"solid",icon:s.jsx(ue,{}),onClick:()=>z(t),children:"Return"}),v&&s.jsx(o,{size:"xs",variant:"solid",color:"red",icon:s.jsx(Q,{}),onClick:()=>H(t),title:"Delete Assignment"})]})}}],[j,w,S,v]);return N?s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsxs("span",{className:"text-red-500",children:["Error: ",N.message]})}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[s.jsxs("div",{className:"flex gap-4 flex-1",children:[s.jsx(se,{placeholder:"Search assignments...",onChange:e=>B(e.target.value),className:"max-w-md"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",id:"overdue-filter",checked:x,onChange:e=>q(e.target.checked),className:"rounded"}),s.jsx("label",{htmlFor:"overdue-filter",className:"text-sm",children:"Show overdue only"})]})]}),s.jsx(o,{icon:s.jsx(ie,{}),onClick:()=>$(),children:"Refresh"})]}),s.jsx(ee,{ref:T,columns:U,data:((I=l==null?void 0:l.data)==null?void 0:I.data)||[],loading:G,pagingData:{total:((R=(D=l==null?void 0:l.data)==null?void 0:D.pagination)==null?void 0:R.total)||0,pageIndex:c.page,pageSize:c.limit},onPaginationChange:e=>p(t=>({...t,page:e})),onSelectChange:e=>p({page:1,limit:e})}),s.jsxs(L,{isOpen:n.open,onClose:h,onRequestClose:h,width:500,children:[s.jsx("h4",{className:"mb-4",children:"Return Product"}),n.assignment&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),s.jsx("p",{className:"font-semibold",children:n.assignment.productName})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Item"}),s.jsx("p",{className:"text-gray-600",children:n.assignment.inventoryInfo})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Return Condition"}),s.jsx(k,{value:{value:n.condition,label:n.condition.charAt(0).toUpperCase()+n.condition.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:e=>g({...n,condition:e.value})})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Inventory Status After Return"}),s.jsx(k,{value:{value:n.inventoryStatus,label:n.inventoryStatus.charAt(0).toUpperCase()+n.inventoryStatus.slice(1).toLowerCase()},options:[{value:"AVAILABLE",label:"Available"},{value:"MAINTENANCE",label:"Needs Maintenance"},{value:"DAMAGED",label:"Damaged"}],onChange:e=>g({...n,inventoryStatus:e.value})}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Choose the status for the inventory item after return"})]}),s.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[s.jsx(o,{variant:"plain",onClick:h,children:"Cancel"}),s.jsx(o,{variant:"solid",onClick:_,loading:C.isLoading,icon:s.jsx(ae,{}),children:"Confirm Return"})]})]})]}),s.jsxs(L,{isOpen:r.open,onClose:()=>d({open:!1,assignment:null}),onRequestClose:()=>d({open:!1,assignment:null}),width:400,children:[s.jsx("h4",{className:"mb-4",children:"Delete Assignment"}),r.assignment&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("p",{className:"text-gray-600",children:"Are you sure you want to delete this assignment?"}),s.jsxs("div",{className:"bg-red-50 p-3 rounded-md",children:[s.jsx("p",{className:"font-semibold text-red-700",children:r.assignment.productName}),s.jsxs("p",{className:"text-red-600 text-sm",children:["Assigned to: ",r.assignment.employeeName]})]}),s.jsx("p",{className:"text-sm text-gray-500",children:"This action will return the inventory item to available stock and cannot be undone."}),s.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[s.jsx(o,{variant:"plain",onClick:()=>d({open:!1,assignment:null}),children:"Cancel"}),s.jsx(o,{variant:"solid",color:"red",onClick:V,loading:A.isLoading,icon:s.jsx(Q,{}),children:"Delete Assignment"})]})]})]})]})},ze=()=>s.jsxs(Z,{className:"h-full",bodyClass:"h-full",children:[s.jsx("div",{className:"lg:flex items-center justify-between mb-4",children:s.jsx("h3",{className:"mb-4 lg:mb-0",children:"Product Assignments"})}),s.jsx(ge,{})]});export{ze as default};
