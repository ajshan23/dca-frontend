import{r as l,J as ie,T as Ce,j as e}from"./index-DOAI5wD-.js";import{A as Ae}from"./AdaptableCard-DutTnGXQ.js";import"./Views-DsXxJgF6.js";import{B as y}from"./Card-B7s_QonD.js";import"./chart.config-BYXH-7qX.js";import"./index-DWx7u_gE.js";import{B as n}from"./Button-XDzj27iK.js";import{D,a as Oe,t as o,N as r}from"./Upload-BcjT7ecx.js";import{D as we}from"./DataTable-DjDyXVg4.js";import{I as k}from"./hoist-non-react-statics.cjs-B_CdNjYy.js";import"./SvgIcon-Bm42TXYj.js";import{S as N}from"./index-c39d8Au7.js";import{v as Pe,w as Ie,z as Ee,A as Fe,B as De,u as Re,y as Le}from"./index-Bs40O9gV.js";import{u as Te}from"./useThemeClass-DFTSSPwM.js";import{u as ne}from"./useQuery-DE2si_Nz.js";import{u as R}from"./useMutation-COMEHNJA.js";import{d as Be}from"./debounce-B-VSmyG_.js";import{d as Me,e as qe,f as ze,g as Ge,h as Qe}from"./ProductService-C-reRKyq.js";import{a as $e}from"./EmployeeService.ts-BdBHdwbM.js";import"./Alert--60sw6Eb.js";import"./index-B5w90T9J.js";import"./Drawer-rypE1f-W.js";import"./index-CcD7OED0.js";import"./index-BymdkX6d.js";import"./ScrollBar-9QFGDQMi.js";import{B as He}from"./index-07rNRI90.js";import"./index-Chjiymov.js";import"./toString-DOk9WYfW.js";import"./proxy-BSpLPB4F.js";import"./CloseButton-Ck51-gyX.js";import"./cloneDeep-DJN0yfLA.js";import"./_getPrototype-BB3-PSDv.js";const Ke=()=>{var Z,ee,se,te,ae;const C=l.useRef(null),A=ie(),O=Ce(),{textTheme:oe}=Te(),[L,re]=l.useState(""),[m,w]=l.useState({page:1,limit:10}),[x,ce]=l.useState(""),[de,T]=l.useState(!1),[ue,me]=l.useState(!1),[xe,B]=l.useState(!1),[i,g]=l.useState(null),[c,he]=l.useState(null),[d,M]=l.useState(null),[j,q]=l.useState(null),[z,G]=l.useState(""),[h,Q]=l.useState("GOOD"),[P,I]=l.useState([]),[p,$]=l.useState(null),[E,H]=l.useState(1),[F,K]=l.useState([""]),{data:u,isLoading:pe,error:_,refetch:ge}=ne({queryKey:["products",m,L,x],queryFn:()=>Qe({page:m.page,limit:m.limit,search:L,stockStatus:x||void 0})}),{data:v}=ne({queryKey:["employees-for-assignment"],queryFn:()=>$e({page:1,limit:100})}),U=R({mutationFn:qe,onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product assigned successfully"})),O.invalidateQueries(["products"]),b()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to assign product"}))}}),J=R({mutationFn:s=>Ge(s.assignmentId,{condition:s.condition,notes:s.notes,inventoryStatus:s.condition==="POOR"?"DAMAGED":"AVAILABLE"}),onSuccess:()=>{o.push(e.jsx(r,{title:"Success",type:"success",children:"Product returned successfully"})),O.invalidateQueries(["products"]),f()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to return product"}))}}),V=R({mutationFn:s=>ze(s.productId,s.stockData),onSuccess:s=>{var t;o.push(e.jsx(r,{title:"Success",type:"success",children:((t=s.data)==null?void 0:t.message)||"Stock added successfully"})),O.invalidateQueries(["products"]),S()},onError:s=>{var t,a;o.push(e.jsx(r,{title:"Error",type:"danger",children:((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to add stock"}))}}),je=l.useMemo(()=>Be(s=>{re(s),w(t=>({...t,page:1}))},500),[]),b=()=>{g(null),M(null),$(null),q(null),G(""),I([]),T(!1)},f=()=>{he(null),Q("GOOD"),me(!1)},S=()=>{g(null),H(1),K([""]),B(!1)},ve=async s=>{var t;g({id:s.id,name:s.name});try{const a=await Me(s.id);I(((t=a.data)==null?void 0:t.data)||[])}catch(a){console.error("Failed to fetch available inventory:",a),I([])}T(!0)},be=s=>{g({id:s.id,name:s.name}),B(!0)},fe=async()=>{!i||!d||await U.mutateAsync({productId:i.id,employeeId:d,inventoryId:p||void 0,expectedReturnAt:j==null?void 0:j.toISOString(),notes:z,autoSelect:!p})},Se=async()=>{if(!(c!=null&&c.id)){o.push(e.jsx(r,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}await J.mutateAsync({assignmentId:c.id,condition:h,notes:`Returned in ${h.toLowerCase()} condition`})},ye=async()=>{if(!i)return;const s={quantity:E,serialNumbers:F.filter(t=>t.trim()),reason:"Stock replenishment"};await V.mutateAsync({productId:i.id,stockData:s})},W=l.useMemo(()=>{var s,t;return((t=(s=v==null?void 0:v.data)==null?void 0:s.data)==null?void 0:t.map(a=>({value:a.id,label:`${a.name} (${a.empId})`})))||[]},[v]),X=l.useMemo(()=>P.map(s=>({value:s.id,label:s.serialNumber||`Item #${s.id}`,extra:`${s.condition} condition`})),[P]),Y=[{value:"",label:"All Products"},{value:"available",label:"Available"},{value:"low",label:"Low Stock"},{value:"out",label:"Out of Stock"}],ke=s=>{const{stockStatus:t,availableStock:a}=s;switch(t){case"OUT_OF_STOCK":return e.jsx(y,{className:"bg-red-500 text-white",children:"Out of Stock"});case"LOW_STOCK":return e.jsxs(y,{className:"bg-yellow-500 text-white",children:["Low Stock (",a,")"]});default:return e.jsxs(y,{className:"bg-green-500 text-white",children:["Available (",a,")"]})}},Ne=l.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.row.original.model})]})},{header:"Category",cell:s=>{var t;return((t=s.row.original.category)==null?void 0:t.name)||"-"}},{header:"Branch",cell:s=>{var t;return((t=s.row.original.branch)==null?void 0:t.name)||"-"}},{header:"Stock Status",cell:s=>{const t=s.row.original.stockInfo;return e.jsxs("div",{children:[ke(t),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Total: ",t==null?void 0:t.totalStock," | Assigned: ",t.assignedStock]})]})}},{header:"Min Stock",cell:s=>s.row.original.minStockLevel},{header:"Compliance",cell:s=>e.jsx(y,{className:s.row.original.complianceStatus?"bg-green-500 text-white":"bg-red-500 text-white",children:s.row.original.complianceStatus?"Compliant":"Non-compliant"})},{header:"Actions",id:"action",cell:s=>{const t=s.row.original,a=t.stockInfo.availableStock>0;return e.jsxs("div",{className:"flex justify-end text-lg gap-2",children:[e.jsx(n,{size:"xs",icon:e.jsx(Pe,{}),onClick:()=>A(`/products/view/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Ie,{}),onClick:()=>A(`/products/edit/${t.id}`)}),e.jsx(n,{size:"xs",icon:e.jsx(Ee,{}),onClick:()=>be(t),variant:"twoTone",children:"Stock"}),a?e.jsx(n,{size:"xs",icon:e.jsx(Fe,{}),onClick:()=>ve(t),variant:"solid",children:"Assign"}):e.jsx(n,{size:"xs",disabled:!0,variant:"plain",children:"No Stock"})]})}}],[A,oe]);return _?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",_.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 gap-4",children:[e.jsxs("div",{className:"flex gap-4 flex-1",children:[e.jsx(k,{placeholder:"Search products...",onChange:s=>je(s.target.value),className:"max-w-md"}),e.jsx(N,{placeholder:"Filter by stock",options:Y,value:x?{value:x,label:(Z=Y.find(s=>s.value===x))==null?void 0:Z.label}:null,onChange:s=>ce((s==null?void 0:s.value)||""),className:"min-w-[200px]",isClearable:!0})]}),e.jsx(n,{icon:e.jsx(De,{}),onClick:()=>ge(),children:"Refresh"})]}),e.jsx(we,{ref:C,columns:Ne,data:((ee=u==null?void 0:u.data)==null?void 0:ee.data)||[],loading:pe,pagingData:{total:((se=u==null?void 0:u.data)==null?void 0:se.total)||0,pageIndex:m.page,pageSize:m.limit},onPaginationChange:s=>w(t=>({...t,page:s})),onSelectChange:s=>w({page:1,limit:s})}),e.jsxs(D,{isOpen:de,onClose:b,onRequestClose:b,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(N,{placeholder:"Select Employee",options:W,value:d?{value:d,label:(te=W.find(s=>s.value===d))==null?void 0:te.label}:null,onChange:s=>M(s==null?void 0:s.value)})]}),P.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Specific Item (Optional - Auto-select if not chosen)"}),e.jsx(N,{placeholder:"Auto-select available item",options:X,value:p?{value:p,label:(ae=X.find(s=>s.value===p))==null?void 0:ae.label}:null,onChange:s=>$(s==null?void 0:s.value),isClearable:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave empty to auto-assign the next available item (FIFO)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Expected Return Date (Optional)"}),e.jsx(Oe,{placeholder:"Select date",value:j,onChange:s=>q(s)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(k,{type:"text",value:z,onChange:s=>G(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:b,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:fe,loading:U.isLoading,disabled:!d,children:"Confirm Assignment"})]})]})]}),e.jsxs(D,{isOpen:xe,onClose:S,onRequestClose:S,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Add Stock"}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:i.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(k,{type:"number",min:"1",max:"100",value:E,onChange:s=>H(Number(s.target.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Serial Numbers (Optional)"}),Array.from({length:E},(s,t)=>e.jsx(k,{type:"text",placeholder:`Serial number ${t+1}`,value:F[t]||"",onChange:a=>{const le=[...F];le[t]=a.target.value,K(le)},className:"mb-2"},t)),e.jsx("p",{className:"text-xs text-gray-500",children:"Leave empty for non-serialized items"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:S,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:ye,loading:V.isLoading,icon:e.jsx(He,{}),children:"Add Stock"})]})]})]}),e.jsxs(D,{isOpen:ue,onClose:f,onRequestClose:f,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:c.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(N,{value:{value:h,label:h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()},options:[{value:"EXCELLENT",label:"Excellent"},{value:"GOOD",label:"Good"},{value:"FAIR",label:"Fair"},{value:"POOR",label:"Poor"}],onChange:s=>Q(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(n,{variant:"plain",onClick:f,children:"Cancel"}),e.jsx(n,{variant:"solid",onClick:Se,loading:J.isLoading,icon:e.jsx(Re,{}),children:"Confirm Return"})]})]})]})]})},_e=()=>{const C=ie();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(n,{variant:"solid",size:"sm",icon:e.jsx(Le,{}),onClick:()=>C("/products/create"),children:"Add Product"})})},Cs=()=>e.jsxs(Ae,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(_e,{})]}),e.jsx(Ke,{})]});export{Cs as default};
